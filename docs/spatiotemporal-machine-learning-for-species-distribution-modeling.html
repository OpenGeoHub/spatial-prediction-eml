<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Spatiotemporal Machine Learning for Species Distribution Modeling | Spatial and spatiotemporal interpolation using Ensemble Machine Learning</title>
<meta name="author" content="Tom Hengl, Leandro Parente and Carmelo Bonannella">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.14/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BH6J2NKGP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1BH6J2NKGP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spatial and spatiotemporal interpolation using Ensemble Machine Learning</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></li>
<li><a class="" href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="" href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-interpolation-using-ensemble-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></li>
<li><a class="active" href="spatiotemporal-machine-learning-for-species-distribution-modeling.html"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="" href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">6</span> Multi-scale spatial prediction models</a></li>
<li><a class="" href="summary-1.html"><span class="header-section-number">7</span> Summary</a></li>
<li><a class="" href="references.html"><span class="header-section-number">8</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OpenGeoHub/spatial-prediction-eml">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatiotemporal-machine-learning-for-species-distribution-modeling" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling<a class="anchor" aria-label="anchor" href="#spatiotemporal-machine-learning-for-species-distribution-modeling"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<p>You are reading the work-in-progress Spatial and spatiotemporal interpolation using Ensemble Machine Learning. This chapter is currently draft version, a peer-review publication is pending. You can find the polished first edition at <a href="https://opengeohub.github.io/spatial-prediction-eml/" class="uri">https://opengeohub.github.io/spatial-prediction-eml/</a>.</p>
</div>
<div id="species-distribution-modeling" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Species Distribution Modeling<a class="anchor" aria-label="anchor" href="#species-distribution-modeling"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://rspatial.org/raster/sdm/">Species Distribution Modeling</a> (SDM) and/or Mapping aims
at explaining and mapping distribution of species as a function of ecological conditions
and/or human influence. Typical steps in SDM include <span class="citation">(<a href="references.html#ref-hijmans2019spatial" role="doc-biblioref">Hijmans, 2019</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>Prepare locations of occurrence of a species or species density;<br>
</li>
<li>Prepare environmental predictor variables (climate, terrain, surface water);<br>
</li>
<li>Fit a SDM model that can be used either to predict natural habitat / Niche and/or occurrence probability;<br>
</li>
<li>Predict habitat / occurrence probability across the region of interest (and perhaps for a future or past climate).</li>
</ol>
<p>Modeling species distribution is different from mapping quantitative soil properties
and/or land surface temperature. Species data comes with specific properties that include <span class="citation">Fois, Cuena-Lombraña, Fenu, &amp; Bacchetta (<a href="references.html#ref-fois2018using" role="doc-biblioref">2018</a>)</span>:</p>
<ul>
<li>Typically occurrence-only data is available: biologists / ecologists often only record where some species was observed;<br>
</li>
<li>Species and their dynamics is complex; some species such as migratory birds change location seasonaly, some are more static;<br>
</li>
<li>Modeling distribution of species such as birds or similar animals and insects in spacetime context is highly complex;</li>
</ul>
<p>In this chapter we provide a scalable framework for predicting either <strong>probability of
occurrence</strong> and/or <strong>species density</strong> (number of individuals per area) using Ensemble
ML and spatiotemporal data (time-series of images). A review of ML methods for SDM
is available also in <span class="citation">J. Zhang &amp; Li (<a href="references.html#ref-zhang2017review" role="doc-biblioref">2017</a>)</span>.</p>
<p>In order to be able to interpolate species distribution, probability of occurrence
and/or density of species in space-time using Ensemble ML, we can not simply use occurrence-only data.
Instead, we need to provide enough training data on both occurrence and absence of
the specific species. If absence training points are not available, we can use various
method do derive most likely locations where certain species do NOT occur i.e. are
highly unlikely to occur due to ecological limitations such as minimum winter temperature
minimum rainfall or similar. These are referred to as the <strong>pseudo-absence</strong> training points.
Pseudo-absence points can be generated in several ways <span class="citation">(<a href="references.html#ref-Iturbide2015" role="doc-biblioref">Iturbide et al., 2015</a>)</span>.
In this tutorial we will show how to generate pseudo-absence data using the <a href="https://github.com/rbchan/maxlike">maxlike
package</a>; alternatively one could also use the
<a href="https://github.com/johnbaums/rmaxent">maxent algorithm</a> or similar.</p>
</div>
<div id="tiger-mosquito-over-europe" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Tiger Mosquito over Europe<a class="anchor" aria-label="anchor" href="#tiger-mosquito-over-europe"><i class="fas fa-link"></i></a>
</h2>
<p>The tiger mosquito (<a href="https://www.ecdc.europa.eu/en/disease-vectors/facts/mosquito-factsheets/aedes-albopictus">Aedes albopictus</a>) is a vector species for many different viruses
including those responsible for dengue fever, Zika and chikungunya. The natural habitat
of this species was limited in the past, however, in the recent time this species has spread
to many countries through the transport of goods and international travel e.g. shipping
routes or similar <span class="citation">Da Re, Montecino-Latorre, Vanwambeke, &amp; Marcantonio (<a href="references.html#ref-da2021will" role="doc-biblioref">2021</a>)</span>. The R package <strong><a href="https://cran.r-project.org/web/packages/dynamAedes/vignettes/dynamAedes_tutorial.html">dynamAedes</a></strong>
contains stochastic, time-discrete and spatially-explicit population dynamical models for <em>Aedes sp.</em>
invesive species <span class="citation">(<a href="references.html#ref-da2021dynamaedes" role="doc-biblioref">Da Re et al., 2021</a>)</span>.</p>
<p>We can obtain occurrences of the <em>Aedes albopictus</em> by either using the <code>rgbif::</code>
function, or by downloading the CSV file from the <a href="https://www.gbif.org/species/1651430">GBIF website</a>.
A local copy of the occurrences for Europe can be loaded by using:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## occ = rgbif::occ_data(taxonKey=1651430, hasCoordinate = TRUE, year = '2000,2022')</span>
<span class="va">occ</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/gbif_aedes_albopictus_mood.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">occ</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    13834 obs. of  9 variables:</span>
<span class="co">#&gt;  $ occurrenceID                 : chr  "https://observation.org/observation/226030224" "https://observation.org/observation/229897504" "https://observation.org/observation/222737616" "https://observation.org/observation/221356176" ...</span>
<span class="co">#&gt;  $ scientificName               : chr  "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" ...</span>
<span class="co">#&gt;  $ individualCount              : num  1 1 1 1 10 125 22 3 2 2 ...</span>
<span class="co">#&gt;  $ Date                         : Date, format: "2021-09-21" "2021-07-22" ...</span>
<span class="co">#&gt;  $ coordinateUncertaintyInMeters: num  43 25 356 4 NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ decimalLongitude             : num  3.206 -0.349 4.863 -0.647 12.726 ...</span>
<span class="co">#&gt;  $ decimalLatitude              : num  42 43.3 45.8 38.1 42.1 ...</span>
<span class="co">#&gt;  $ Year                         : int  2021 2021 2021 2021 2020 2020 2020 2020 2020 2020 ...</span>
<span class="co">#&gt;  $ olc_c                        : chr  "8FH5X6G4+VF3" "8CMX8M42+Q8G" "8FQ6QVW7+M8J" "8CCX49J3+95Q" ...</span></code></pre></div>
<p>To visualize the mosquito point data over Europe we can use e.g.:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/edzer/spacetime">spacetime</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>
<span class="va">sp_ST</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spacetime/man/STIDF-class.html">STIDF</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/plotKML/man/layer.SpatialPoints.html">SpatialPoints</a></span><span class="op">(</span><span class="va">occ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span><span class="op">]</span>, proj4string <span class="op">=</span> <span class="st">"EPSG:4326"</span><span class="op">)</span>, 
               <span class="va">occ</span><span class="op">$</span><span class="va">Date</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>individualCount<span class="op">=</span><span class="va">occ</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">SAGA_pal</span><span class="op">)</span>
<span class="co">## plot in Google Earth:</span>
<span class="fu"><a href="https://rdrr.io/pkg/plotKML/man/plotKML.html">plotKML</a></span><span class="op">(</span><span class="va">sp_ST</span>, colour_scale<span class="op">=</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:google-vis"></span>
<img src="img/tiger_mosquito_europe_2000_2021.gif" alt="Spatiotemporal visualization of the GBIF occurrence records of the Tiger mosquito." width="90%"><p class="caption">
Figure 5.1: Spatiotemporal visualization of the GBIF occurrence records of the Tiger mosquito.
</p>
</div>
</div>
<div id="generating-pseudo-absence-data" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Generating pseudo-absence data<a class="anchor" aria-label="anchor" href="#generating-pseudo-absence-data"><i class="fas fa-link"></i></a>
</h2>
<p>To generate pseudo-absence data we can use the maxlike package. First, we need
to prepare enough ecological information that can help us map habitat of the species
using all records for Europe. In the local folder we can find:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eco.tifs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"./input/mood4km/static"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html">glob2rx</a></span><span class="op">(</span><span class="st">"*.tif$"</span><span class="op">)</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">eco.tifs</span><span class="op">)</span>
<span class="co">#&gt;  [1] "clm_bioclim.1_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [2] "clm_bioclim.12_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [3] "clm_bioclim.13_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [4] "clm_bioclim.14_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [5] "clm_bioclim.5_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [6] "clm_bioclim.6_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [7] "clm_lst_mod11a2.nighttime.m01_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt;  [8] "clm_lst_mod11a2.nighttime.m03_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt;  [9] "clm_lst_mod11a2.nighttime.m06_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt; [10] "clm_lst_mod11a2.nighttime.m09_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt; [11] "clm_snow.prob_esacci.dec_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [12] "clm_snow.prob_esacci.feb_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [13] "clm_snow.prob_esacci.jan_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [14] "dtm_elevation_glo90.copernicus_m_4km_s0..0cm_2019_epsg.4326_mood_v1.0.tif"</span></code></pre></div>
<p>i.e. <a href="https://chelsa-climate.org/bioclim/">CHELSA Climate Bioclim layers</a> mean
annual air temperature, annual precipitation amount and similar, <a href="https://doi.org/10.5281/zenodo.1420114">MODIS Long-term nighttime Land Surface
Temperatures</a> for months 1, 3, 6 and 9,
<a href="https://doi.org/10.5281/zenodo.5774953">snow probability images for winter months</a> and DTM elevation model from Copernicus.
We can load the stack of rasters to R and use principal components to reduce
overlap between different layers:</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gc()</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">eco.tifs</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">g4km</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span>
<span class="va">cc.4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">g4km</span><span class="op">@</span><span class="va">data</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">g4km</span>, <span class="st">"SpatialPixelsDataFrame"</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="va">g4km</span><span class="op">[</span><span class="va">cc.4km</span>,<span class="op">]</span>
<span class="co">#summary(cc.4km)</span>
<span class="co">## 2.2M pixels</span>
<span class="co">#plot(g4km[14])</span>
<span class="va">g4km.spc</span> <span class="op">=</span> <span class="fu">landmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/landmap/man/spc.html">spc</a></span><span class="op">(</span><span class="va">g4km</span><span class="op">)</span></code></pre></div>
<p>Next, we can fit a <code>maxlike</code> model for occurrence probability using presence only data,
and predict values at all locations:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gc()</span>
<span class="va">max.fm</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">max.ml</span> <span class="op">&lt;-</span> <span class="fu">maxlike</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/maxlike/man/maxlike.html">maxlike</a></span><span class="op">(</span>formula<span class="op">=</span><span class="va">max.fm</span>, rasters<span class="op">=</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>, points<span class="op">=</span><span class="va">occ.sp</span><span class="op">@</span><span class="va">coords</span>, method<span class="op">=</span><span class="st">"BFGS"</span>, savedata<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#ment.ml &lt;- dismo::maxent(raster::stack(g4km.spc@predicted[1:12]), occ.sp@coords)</span>
<span class="co">## bug in "maxlike" (https://github.com/rbchan/maxlike/issues/1); need to replace this 'by hand':</span>
<span class="va">max.ml</span><span class="op">$</span><span class="va">call</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">max.fm</span>
<span class="co">## TH: this operation can be time consuming and is not recommended for large grids</span>
<span class="va">max.ml.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">max.ml</span><span class="op">)</span>
<span class="va">max.ml.p</span> <span class="op">&lt;-</span> <span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">max.ml.p</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pseudo-absences"></span>
<img src="img/Fig_predicted_maxlike_tiger_mosquito.jpg" alt="Predicted probability of occurence for Tiger mosquito based on the maxent analysis." width="90%"><img src="img/Fig_predicted_maxlike_tiger_mosquito_Spain.jpg" alt="Predicted probability of occurence for Tiger mosquito based on the maxent analysis." width="90%"><p class="caption">
Figure 5.2: Predicted probability of occurence for Tiger mosquito based on the maxent analysis.
</p>
</div>
<p>This shows that the Tiger mosquito seems to prefer coastal areas and is mainly limited
by the winter temperatures. The minimum temperature for survival of the mosquito adults
is about 3-4 degrees, for eggs minimum temperature is lower but still should be &gt; -4 degrees.</p>
<p>Next, we can generate a reasonable number of pseudo-absences (they should not exceed
actual number of occurrence points) by using:</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">max.ml.p</span> <span class="op">=</span> <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="st">"./output/occ.prob_aedes_albopictus.tif"</span><span class="op">)</span>
<span class="co">## insert 0 values for all occurrences before the date:</span>
<span class="va">max.ml.p</span><span class="op">$</span><span class="va">absence</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">$</span><span class="va">band1</span><span class="op">==</span><span class="fl">100</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>
<span class="va">dens.var</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.im.html">as.im</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/image.html">as.image.SpatialGridDataFrame</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">[</span><span class="st">"absence"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">pnts.new</span> <span class="op">&lt;-</span> <span class="fu">rpoint</span><span class="op">(</span><span class="fl">600</span>, f<span class="op">=</span><span class="va">dens.var</span><span class="op">)</span></code></pre></div>
<p>A single realisation of 600 pseudo-absences:</p>
<div class="figure" style="text-align: center">
<span id="fig:pnts-eu"></span>
<img src="img/Fig_pseudo_absences_mood.jpg" alt="Simulated pseudo-absences based on the maxent analysis (predictions in the background)." width="80%"><p class="caption">
Figure 5.3: Simulated pseudo-absences based on the maxent analysis (predictions in the background).
</p>
</div>
</div>
<div id="modeling-distribution-of-mosquitos-through-time" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Modeling distribution of mosquitos through time<a class="anchor" aria-label="anchor" href="#modeling-distribution-of-mosquitos-through-time"><i class="fas fa-link"></i></a>
</h2>
<p>Next we can bind the occurrences / adult counts and pseudo-absences, then overlay
training points in spacetime to produce a spatiotemporal regression-matrix:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rm.all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/regmatrix_aedes_1km.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">)</span>
<span class="co">#&gt; [1] 27034   182</span></code></pre></div>
<p>This is now a relatively large regression matrix with basically diversity of Earth Observation
and climatic time-series of images. We can fit an Ensemble ML model to predict spatiotemporal
distribution of species for 2000-2021 period by using:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"mood_functions.R"</span><span class="op">)</span>
<span class="va">rm.all</span><span class="op">$</span><span class="va">log.Count</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span> <span class="va">x</span>  <span class="op">&lt;-</span> <span class="fu">train_eml</span><span class="op">(</span>t.var<span class="op">=</span><span class="st">"log.Count"</span>, pr.var<span class="op">=</span><span class="va">pr.vars</span>, X<span class="op">=</span><span class="va">rm.all</span>, rf.feature<span class="op">=</span><span class="cn">FALSE</span>, out.dir<span class="op">=</span><span class="st">"./output/"</span><span class="op">)</span> <span class="op">)</span>
<span class="fu">cat_eml</span><span class="op">(</span>t.var<span class="op">=</span><span class="st">"log.Count"</span>, out.dir<span class="op">=</span><span class="st">"./modelsT/"</span>, n.max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">length</a></span><span class="op">(</span><span class="va">pr.vars</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p>which shows the following:</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"./output/eml.m_log.Count.rds"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">t.m</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -4.3138 -0.3393 -0.0843  0.0748  6.3857 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)  0.02319    0.01064   2.180   0.0293 *  </span>
<span class="co">#&gt; regr.ranger  1.56557    0.01631  95.969   &lt;2e-16 ***</span>
<span class="co">#&gt; regr.rpart  -0.02256    0.01147  -1.967   0.0492 *  </span>
<span class="co">#&gt; regr.nnet   -0.13971    0.01442  -9.691   &lt;2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.8566 on 25646 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.5143, Adjusted R-squared:  0.5143 </span>
<span class="co">#&gt; F-statistic:  9053 on 3 and 25646 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>The most important variable based on the variable importance seems to be:</p>
<ul>
<li>Night lights (NLT) based on ;<br>
</li>
<li>Travel time to cities and ports based on ;</li>
<li>Population density based on ;</li>
</ul>
</div>
<div id="generating-the-trend-maps" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Generating the trend maps<a class="anchor" aria-label="anchor" href="#generating-the-trend-maps"><i class="fas fa-link"></i></a>
</h2>
<p>After we have produced predictions we can also stack them and then derive beta
coefficient per pixel to see if some parts of Europe are showing higher increase
in mosquito density. For this we can run:</p>
<div class="figure" style="text-align: center">
<span id="fig:pred-count"></span>
<img src="spatiotemporal-sdm_files/figure-html/pred-count-1.png" alt="Predictions of mosquito density over Europe with a zoom in on Spain." width="90%"><p class="caption">
Figure 5.4: Predictions of mosquito density over Europe with a zoom in on Spain.
</p>
</div>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#install.packages("greenbrown", repos="http://R-Forge.R-project.org")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">greenbrown</span><span class="op">)</span>
<span class="va">trendmap</span> <span class="op">&lt;-</span> <span class="fu">TrendRaster</span><span class="op">(</span><span class="va">spain1km</span>, start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">)</span>, freq<span class="op">=</span><span class="fl">1</span>, breaks<span class="op">=</span><span class="fl">1</span><span class="op">)</span> 
<span class="co">## can be computationally intensive</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">trendmap</span><span class="op">[[</span><span class="st">"SlopeSEG1"</span><span class="op">]</span><span class="op">]</span>, 
     col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="st">"SG_COLORS_GREEN_GREY_RED"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
     zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>,<span class="fl">1.5</span><span class="op">)</span>, main<span class="op">=</span><span class="st">"Slope SEG1"</span><span class="op">)</span></code></pre></div>
</div>
<div id="summary" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h2>
<p>This chapter shows how to use occurrence-only records to map distribution of target species in spacetime.
We again use Ensemble Machine Learning on training data overlaid in spacetime vs time-series
of Night Light, vegetation, climatic images (years 2000–2021).
The training data is limited to occurrence-only records and these are neither based on
probability sampling nor a consistent in time. Just because there are more records of the mosquito species
for more recent years, that does not mean that the mosquito has appeared in recent years. In fact,
if we would use year as a covariate, we would most likely introduce a bias in predictions.</p>
<p>The simple alternative to derive (kernel) density maps of mosquitos for Europe would be to use the <code><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">sparr::spattemp.density</a></code>
function:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">st.f</span> <span class="op">=</span> <span class="va">occ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>,<span class="st">"decimalLatitude"</span>,<span class="st">"Date"</span>,<span class="st">"individualCount"</span><span class="op">)</span><span class="op">]</span>
<span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:4326"</span><span class="op">)</span>
<span class="va">grid1d</span> <span class="op">=</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"./input/mask_5km.tif"</span><span class="op">)</span>
<span class="va">grid1d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">grid1d</span>, <span class="st">"SpatialPixelsDataFrame"</span><span class="op">)</span>
<span class="va">te</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">grid1d</span><span class="op">@</span><span class="va">bbox</span><span class="op">)</span>
<span class="co">#plot(grid1d)</span>
<span class="va">mg_owin</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.owin.html">as.owin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">grid1d</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">grid1d</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, window <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">st.f_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html">spTransform</a></span><span class="op">(</span><span class="va">st.f</span>, <span class="va">grid1d</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span>
<span class="va">pp</span> <span class="op">=</span> <span class="fu">ppp</span><span class="op">(</span>x<span class="op">=</span><span class="va">st.f_sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y<span class="op">=</span><span class="va">st.f_sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, marks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">st.f_sp</span><span class="op">$</span><span class="va">Date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, window <span class="op">=</span> <span class="va">mg_owin</span><span class="op">)</span>
<span class="co">## Warning messages:</span>
<span class="co">#1: 41072 points were rejected as lying outside the specified window </span>
<span class="co">#2: data contain duplicated points</span>
<span class="va">pp</span><span class="op">$</span><span class="va">n</span>
<span class="co">## 13893</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">pp</span><span class="op">$</span><span class="va">marks</span><span class="op">)</span>
<span class="co">## spacetime density ----</span>
<span class="va">eu.stgrid</span> <span class="op">=</span> <span class="fu">sparr</span><span class="fu">::</span><span class="fu"><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">spattemp.density</a></span><span class="op">(</span><span class="va">pp</span>, tt <span class="op">=</span> <span class="va">pp</span><span class="op">$</span><span class="va">marks</span>, tlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>,<span class="fl">2022</span><span class="op">)</span>, sres<span class="op">=</span><span class="fl">1569</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## Calculating trivariate smooth...Done.</span>
<span class="co">## Edge-correcting...Done.</span>
<span class="co">## Conditioning on time...Done.</span>
<span class="co">#plot(eu.stgrid, 2018)</span>
<span class="va">dmap</span> <span class="op">&lt;-</span> <span class="fu">maptools</span><span class="fu">::</span><span class="fu"><a href="http://maptools.r-forge.r-project.org/reference/as.im.html">as.SpatialGridDataFrame.im</a></span><span class="op">(</span><span class="va">eu.stgrid</span><span class="op">$</span><span class="va">z</span><span class="op">[[</span><span class="st">"2012"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">dmap</span><span class="op">$</span><span class="va">v</span><span class="op">*</span><span class="fl">1e12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dmap</span><span class="op">)</span></code></pre></div>
<p>The problem of this approach is that (a) it can not work with count data, (b) it
assumes that ALL or equaly sampled occurrences of the phenomena are available.
If this is not the case, the function <code><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">sparr::spattemp.density</a></code> would produce a biased
estimate of the density of mosquitos.</p>
<p>Ensemble Machine Learning, on the other hand, can help produce unbiased estimate of
mosquito densities over Europe for a time-series of years. The disadvantages of the using
spatiotemporal ML are:</p>
<ul>
<li>We are correlating the Earth Observation data with mosquito density, but mosquitos
are dynamic and can not be sensed from space, at least not at 1km resolution;<br>
</li>
<li>We assume that the training points are representative for various environmental conditions, while in practice less
training data is available for physically distant areas e.g. mountains (hence censored);</li>
<li>Predictions produced in this example come with relatively high errors, so the predictions should be
used with care;</li>
</ul>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="spatiotemporal-interpolation-using-ensemble-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></div>
<div class="next"><a href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">6</span> Multi-scale spatial prediction models</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatiotemporal-machine-learning-for-species-distribution-modeling"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="nav-link" href="#species-distribution-modeling"><span class="header-section-number">5.1</span> Species Distribution Modeling</a></li>
<li><a class="nav-link" href="#tiger-mosquito-over-europe"><span class="header-section-number">5.2</span> Tiger Mosquito over Europe</a></li>
<li><a class="nav-link" href="#generating-pseudo-absence-data"><span class="header-section-number">5.3</span> Generating pseudo-absence data</a></li>
<li><a class="nav-link" href="#modeling-distribution-of-mosquitos-through-time"><span class="header-section-number">5.4</span> Modeling distribution of mosquitos through time</a></li>
<li><a class="nav-link" href="#generating-the-trend-maps"><span class="header-section-number">5.5</span> Generating the trend maps</a></li>
<li><a class="nav-link" href="#summary"><span class="header-section-number">5.6</span> Summary</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OpenGeoHub/spatial-prediction-eml/blob/master/spatiotemporal-sdm.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OpenGeoHub/spatial-prediction-eml/edit/master/spatiotemporal-sdm.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spatial and spatiotemporal interpolation using Ensemble Machine Learning</strong>" was written by Tom Hengl, Leandro Parente and Carmelo Bonannella. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
