<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Spatiotemporal Machine Learning for Species Distribution Modeling | Spatial and spatiotemporal interpolation using Ensemble Machine Learning</title>
<meta name="author" content="Tom Hengl, Leandro Parente, Carmelo Bonannella and contributors">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.14/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BH6J2NKGP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1BH6J2NKGP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spatial and spatiotemporal interpolation using Ensemble Machine Learning</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></li>
<li><a class="" href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="" href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></li>
<li><a class="active" href="spatiotemporal-machine-learning-for-species-distribution-modeling.html"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="" href="spatiotemporal-prediction-of-soil-organic-carbon.html"><span class="header-section-number">6</span> Spatiotemporal prediction of Soil Organic Carbon</a></li>
<li><a class="" href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">7</span> Multi-scale spatial prediction models</a></li>
<li><a class="" href="summary-1.html"><span class="header-section-number">8</span> Summary</a></li>
<li><a class="" href="references.html"><span class="header-section-number">9</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OpenGeoHub/spatial-prediction-eml">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatiotemporal-machine-learning-for-species-distribution-modeling" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling<a class="anchor" aria-label="anchor" href="#spatiotemporal-machine-learning-for-species-distribution-modeling"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<p>You are reading the work-in-progress Spatial and spatiotemporal interpolation using Ensemble Machine Learning. This chapter is currently draft version, a peer-review publication is pending. You can find the polished first edition at <a href="https://opengeohub.github.io/spatial-prediction-eml/" class="uri">https://opengeohub.github.io/spatial-prediction-eml/</a>.</p>
</div>
<div id="species-distribution-modeling" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Species Distribution Modeling<a class="anchor" aria-label="anchor" href="#species-distribution-modeling"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://rspatial.org/raster/sdm/">Species Distribution Modeling</a> (SDM) and/or Mapping aims
at explaining and mapping distribution of species as a function of ecological, environmental conditions
and/or human influence. Typical steps in SDM include <span class="citation">(<a href="references.html#ref-hijmans2019spatial" role="doc-biblioref">Hijmans, 2019</a>)</span>:</p>
<ol style="list-style-type: decimal">
<li>Prepare locations of occurrence of a species or species density;<br>
</li>
<li>Prepare environmental predictor variables (climate, terrain, surface water);<br>
</li>
<li>Fit a SDM model that can be used either to predict natural habitat / Niche and/or occurrence probability;<br>
</li>
<li>Predict habitat / occurrence probability across the region of interest (and perhaps for a future or past climate).</li>
</ol>
<p>Modeling species distribution is different from mapping quantitative soil properties
and/or land surface temperature described in previous chapters. Species training data often comes
with specific properties that include <span class="citation">(<a href="references.html#ref-fois2018using" role="doc-biblioref">Fois, Cuena-Lombraña, Fenu, &amp; Bacchetta, 2018</a>; <a href="references.html#ref-martinez2018species" role="doc-biblioref">Martinez-Minaya, Cameletti, Conesa, &amp; Pennino, 2018</a>)</span>:</p>
<ul>
<li>Dealing with occurrence-only records: biologists / ecologists often only record where some species was observed;<br>
</li>
<li>Species and their dynamics is often complex: some species such as migratory birds change location seasonaly;<br>
</li>
<li>Modeling distribution of species such as birds or similar animals and insects
in spacetime context is highly complex as various levels of chaotic behavior apply;</li>
</ul>
<p>In recent years there has been an increasing interest in using Machine Learning for
species distribution modeling, especially to model disease outbreaks.
A review of ML methods for SDM is available also in <span class="citation">J. Zhang &amp; Li (<a href="references.html#ref-zhang2017review" role="doc-biblioref">2017</a>)</span>.
In this chapter we describe a scalable framework for predicting species occurrences
based on the Ensemble Machine Learning described in the <a href="spatiotemporal-ml.html#spatiotemporal-ml">previous chapter</a>.
The target variables of interest in the case of SDM are usually (a) <strong>probability of occurrence</strong>
and/or (b) <strong>species density</strong> (number of individuals per area) and/or (c) habitat
suitability indices. As covariates for SDM we use time-series of
Earth Observation images and similar climatic and terrain-based images.</p>
<p>Extending spatiotemporal Ensemble ML to modeling species distribution is not trivial.
In order to be able to interpolate species distribution, probability of occurrence
and/or density of species in space-time using Ensemble ML, we can not simply
import and model occurrence-only data as these miss any quantities or states.
We need to provide instead run several steps to make data suited for ML.
For example, if absence training points are not available, we can use various
method do derive most likely locations where certain species do NOT occur i.e. are
highly unlikely to occur due to ecological limitations such as minimum winter temperature
minimum rainfall or similar. These are referred to as the <strong>pseudo-absence</strong> training points.
Hence, we will first show how to generate pseudo-absence data using the <a href="https://github.com/rbchan/maxlike">maxlike
package</a>, then after enough of occurrence and
absence records are available, we apply standard ML steps.</p>
</div>
<div id="tiger-mosquito-over-europe" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Tiger Mosquito over Europe<a class="anchor" aria-label="anchor" href="#tiger-mosquito-over-europe"><i class="fas fa-link"></i></a>
</h2>
<p>The tiger mosquito (<a href="https://www.ecdc.europa.eu/en/disease-vectors/facts/mosquito-factsheets/aedes-albopictus">Aedes albopictus</a>) is a vector species for many different viruses
including those responsible for dengue fever, Zika and chikungunya. The natural habitat
of this species was limited in the past, however, in the recent time, this species has spread
to many countries through the transport of goods and international travel e.g. shipping
routes or similar <span class="citation">(<a href="references.html#ref-benedict2007spread" role="doc-biblioref">Benedict, Levine, Hawley, &amp; Lounibos, 2007</a>; <a href="references.html#ref-da2021will" role="doc-biblioref">Da Re, Montecino-Latorre, Vanwambeke, &amp; Marcantonio, 2021</a>)</span>. The R package <strong><a href="https://cran.r-project.org/web/packages/dynamAedes/vignettes/dynamAedes_tutorial.html">dynamAedes</a></strong>
contains stochastic, time-discrete and spatially-explicit population dynamical models for <em>Aedes sp.</em>
invasive species <span class="citation">(<a href="references.html#ref-da2021dynamaedes" role="doc-biblioref">Da Re, Van Bortel, et al., 2021</a>)</span>.</p>
<p>We can obtain occurrences of the <em>Aedes albopictus</em> by either using the <code><a href="https://docs.ropensci.org/rgbif/reference/occ_data.html">rgbif::occ_data</a></code>
function, or by downloading the CSV file from the <a href="https://www.gbif.org/species/1651430">GBIF website</a>.
A local copy of the occurrences for Europe can be loaded by using:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## occ = rgbif::occ_data(taxonKey=1651430, hasCoordinate = TRUE, year = '2000,2022')</span>
<span class="va">occ</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/gbif_aedes_albopictus_mood.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">occ</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    13834 obs. of  9 variables:</span>
<span class="co">#&gt;  $ occurrenceID                 : chr  "https://observation.org/observation/226030224" "https://observation.org/observation/229897504" "https://observation.org/observation/222737616" "https://observation.org/observation/221356176" ...</span>
<span class="co">#&gt;  $ scientificName               : chr  "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" "Aedes albopictus (Skuse, 1894)" ...</span>
<span class="co">#&gt;  $ individualCount              : num  1 1 1 1 10 125 22 3 2 2 ...</span>
<span class="co">#&gt;  $ Date                         : Date, format: "2021-09-21" "2021-07-22" ...</span>
<span class="co">#&gt;  $ coordinateUncertaintyInMeters: num  43 25 356 4 NA NA NA NA NA NA ...</span>
<span class="co">#&gt;  $ decimalLongitude             : num  3.206 -0.349 4.863 -0.647 12.726 ...</span>
<span class="co">#&gt;  $ decimalLatitude              : num  42 43.3 45.8 38.1 42.1 ...</span>
<span class="co">#&gt;  $ Year                         : int  2021 2021 2021 2021 2020 2020 2020 2020 2020 2020 ...</span>
<span class="co">#&gt;  $ olc_c                        : chr  "8FH5X6G4+VF3" "8CMX8M42+Q8G" "8FQ6QVW7+M8J" "8CCX49J3+95Q" ...</span></code></pre></div>
<p>To <a href="https://datastudio.google.com/reporting/ae84bde2-a200-4254-bdd0-017f08a8baa7">visualize the mosquito point data</a> over Europe we can use e.g.:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://github.com/edzer/spacetime">spacetime</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>
<span class="va">sp_ST</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/spacetime/man/STIDF-class.html">STIDF</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/plotKML/man/layer.SpatialPoints.html">SpatialPoints</a></span><span class="op">(</span><span class="va">occ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span><span class="op">]</span>, proj4string <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"EPSG:4326"</span><span class="op">)</span><span class="op">)</span>, 
               <span class="va">occ</span><span class="op">$</span><span class="va">Date</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>individualCount<span class="op">=</span><span class="va">occ</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">SAGA_pal</span><span class="op">)</span>
<span class="co">## plot in Google Earth:</span>
<span class="fu"><a href="https://rdrr.io/pkg/plotKML/man/plotKML.html">plotKML</a></span><span class="op">(</span><span class="va">sp_ST</span>, colour_scale<span class="op">=</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:google-vis"></span>
<img src="img/tiger_mosquito_europe_2000_2021.gif" alt="Spatiotemporal visualization of the GBIF occurrence records of the Tiger mosquito." width="90%"><p class="caption">
Figure 5.1: Spatiotemporal visualization of the GBIF occurrence records of the Tiger mosquito.
</p>
</div>
<p>This shows that mosquito seems to be concentrated in the southern Europe,
primarily along coast-line, although some adults have been spotted also in the
Northern Europe. Note also that the mosquito seems to be continuously spreading
across Europe, however, we are not sure if this is also just because there are
more records in GBIF coming from the last 5 years.</p>
</div>
<div id="generating-pseudo-absence-data" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Generating pseudo-absence data<a class="anchor" aria-label="anchor" href="#generating-pseudo-absence-data"><i class="fas fa-link"></i></a>
</h2>
<p>Pseudo-absence points can be generated in several ways, but most commonly by using
occurrence-only models, expert knowledge and/or geosurveys <span class="citation">(<a href="references.html#ref-Iturbide2015" role="doc-biblioref">Iturbide et al., 2015</a>; <a href="references.html#ref-lobo2010uncertain" role="doc-biblioref">Lobo, Jiménez-Valverde, &amp; Hortal, 2010</a>)</span>.<br>
To generate pseudo-absence data we can use the <a href="https://github.com/rbchan/maxlike">maxlike</a> package. First, we need
to prepare enough ecological information that can help us map habitat of the species
using all records for Europe. In the local folder we can find:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eco.tifs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"./input/mood4km/static"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html">glob2rx</a></span><span class="op">(</span><span class="st">"*.tif$"</span><span class="op">)</span>, full.names<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">eco.tifs</span><span class="op">)</span>
<span class="co">#&gt;  [1] "clm_bioclim.1_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [2] "clm_bioclim.12_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [3] "clm_bioclim.13_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [4] "clm_bioclim.14_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"     </span>
<span class="co">#&gt;  [5] "clm_bioclim.5_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [6] "clm_bioclim.6_chelsa.climate_m_4km_s0..0cm_1980..2010_mood_v2.1.tif"      </span>
<span class="co">#&gt;  [7] "clm_lst_mod11a2.nighttime.m01_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt;  [8] "clm_lst_mod11a2.nighttime.m03_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt;  [9] "clm_lst_mod11a2.nighttime.m06_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt; [10] "clm_lst_mod11a2.nighttime.m09_p50_4km_s0..0cm_2000..2021_mood_v1.2.tif"   </span>
<span class="co">#&gt; [11] "clm_snow.prob_esacci.dec_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [12] "clm_snow.prob_esacci.feb_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [13] "clm_snow.prob_esacci.jan_p.90_4km_s0..0cm_2000..2012_mood_v2.0.tif"       </span>
<span class="co">#&gt; [14] "dtm_elevation_glo90.copernicus_m_4km_s0..0cm_2019_epsg.4326_mood_v1.0.tif"</span></code></pre></div>
<p>i.e. <a href="https://chelsa-climate.org/bioclim/">CHELSA Climate Bioclim layers</a> mean
annual air temperature, annual precipitation amount and similar, <a href="https://doi.org/10.5281/zenodo.1420114">MODIS Long-term nighttime Land Surface
Temperatures</a> for months 1, 3, 6 and 9,
<a href="https://doi.org/10.5281/zenodo.5774953">snow probability images for winter months</a> and DTM elevation model from Copernicus.
We can load the stack of rasters into R and use principal components to reduce
overlap between different layers:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gc()</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">eco.tifs</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">g4km</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span>
<span class="va">cc.4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">g4km</span><span class="op">@</span><span class="va">data</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">g4km</span>, <span class="st">"SpatialPixelsDataFrame"</span><span class="op">)</span>
<span class="va">g4km</span> <span class="op">=</span> <span class="va">g4km</span><span class="op">[</span><span class="va">cc.4km</span>,<span class="op">]</span>
<span class="co">#summary(cc.4km)</span>
<span class="co">## 2.2M pixels</span>
<span class="co">#plot(g4km[14])</span>
<span class="va">g4km.spc</span> <span class="op">=</span> <span class="fu">landmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/landmap/man/spc.html">spc</a></span><span class="op">(</span><span class="va">g4km</span><span class="op">)</span>
<span class="co">#&gt; Converting covariates to principal components...</span></code></pre></div>
<p>Next, we can fit a <code>maxlike</code> model for occurrence probability using presence only data,
and predict values at all locations:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">occ.sp</span> <span class="op">=</span> <span class="va">occ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>,<span class="st">"decimalLatitude"</span>,<span class="st">"Year"</span>,<span class="st">"olc_c"</span><span class="op">)</span><span class="op">]</span>
<span class="va">occ.sp</span> <span class="op">=</span> <span class="va">occ.sp</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">occ.sp</span><span class="op">$</span><span class="va">olc_c</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">occ.sp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">occ.sp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:4326"</span><span class="op">)</span>
<span class="va">occ.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html">spTransform</a></span><span class="op">(</span><span class="va">occ.sp</span>, <span class="st">"EPSG:3035"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#gc()</span>
<span class="va">max.fm</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"~"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">max.ml</span> <span class="op">&lt;-</span> <span class="fu">maxlike</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/maxlike/man/maxlike.html">maxlike</a></span><span class="op">(</span>formula<span class="op">=</span><span class="va">max.fm</span>, rasters<span class="op">=</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>, points<span class="op">=</span><span class="va">occ.sp</span><span class="op">@</span><span class="va">coords</span>, method<span class="op">=</span><span class="st">"BFGS"</span>, savedata<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#ment.ml &lt;- dismo::maxent(raster::stack(g4km.spc@predicted[1:12]), occ.sp@coords)</span>
<span class="co">## bug in "maxlike" (https://github.com/rbchan/maxlike/issues/1); need to replace this 'by hand':</span>
<span class="va">max.ml</span><span class="op">$</span><span class="va">call</span><span class="op">$</span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">max.fm</span>
<span class="co">## TH: this operation can be time consuming and is not recommended for large grids</span>
<span class="va">max.ml.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">max.ml</span><span class="op">)</span>
<span class="va">max.ml.p</span> <span class="op">&lt;-</span> <span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">max.ml.p</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">)</span></code></pre></div>
<p>The resulting maps produced using maxlike are shown below.</p>
<div class="figure" style="text-align: center">
<span id="fig:pseudo-absences"></span>
<img src="img/Fig_predicted_maxlike_tiger_mosquito.jpg" alt="Predicted probability of occurence for Tiger mosquito based on the maxent analysis. Darker-green areas indicated close to 100% probability of occurrence." width="90%"><img src="img/Fig_predicted_maxlike_tiger_mosquito_Spain.jpg" alt="Predicted probability of occurence for Tiger mosquito based on the maxent analysis. Darker-green areas indicated close to 100% probability of occurrence." width="90%"><p class="caption">
Figure 5.2: Predicted probability of occurence for Tiger mosquito based on the maxent analysis. Darker-green areas indicated close to 100% probability of occurrence.
</p>
</div>
<p>The <code>maxlike</code> occurrence probability map indicates that the Tiger
mosquito seems to prefer coastal areas and is probably limited by the winter temperatures.
The minimum temperature for survival of the mosquito adults is about 3–4 C degrees,
for mosquito eggs minimum temperature is lower but still should be above -4 degrees <span class="citation">(<a href="references.html#ref-da2021will" role="doc-biblioref">Da Re, Montecino-Latorre, et al., 2021</a>)</span>.
Note for habitat suitability analysis one could also use the <a href="https://github.com/johnbaums/rmaxent">maxent algorithm</a>
or do analysis in both maxlike and maxent and then produce an ensemble estimate.</p>
<p>Next, we can generate a reasonable number of pseudo-absences (as a rule of thumb,
number of the generated pseudo-absences should not exceed 10% to 20% of the actual
number of occurrence points):</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">max.ml.p</span> <span class="op">=</span> <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"./output/occ.prob_aedes_albopictus.tif"</span><span class="op">)</span>
<span class="co">## insert 0 values for all occurrences before the date:</span>
<span class="va">max.ml.p</span><span class="op">$</span><span class="va">absence</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">$</span><span class="va">band1</span><span class="op">==</span><span class="fl">100</span>, <span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span>
<span class="va">dens.var</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.im.html">as.im</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/image.html">as.image.SpatialGridDataFrame</a></span><span class="op">(</span><span class="va">max.ml.p</span><span class="op">[</span><span class="st">"absence"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="va">pnts.new</span> <span class="op">&lt;-</span> <span class="fu">rpoint</span><span class="op">(</span><span class="fl">600</span>, f<span class="op">=</span><span class="va">dens.var</span><span class="op">)</span></code></pre></div>
<p>A single realization of 600 simulated pseudo-absences is shown below:</p>
<div class="figure" style="text-align: center">
<span id="fig:pnts-eu"></span>
<img src="img/Fig_pseudo_absences_mood.jpg" alt="Simulated pseudo-absences based on the maxent analysis (predictions in the background)." width="80%"><p class="caption">
Figure 5.3: Simulated pseudo-absences based on the maxent analysis (predictions in the background).
</p>
</div>
<p>Note we only use pixels that have 0 probability of occurrence based on the maxlike results.
This way we prevent from introducing any bias into further modeling.
Once we have generated pseudo-absences, we can bind all <code>1</code> and <code>0</code> records together
to produce a regression and/or classification matrix, and which can then be used to
fit ML models.</p>
<p>In the case of the GBIF data two possible target variables could be used:</p>
<ul>
<li>Individual counts i.e. number of adults observed at location;<br>
</li>
<li>Occurrence / absence states i.e. 0/1 values;</li>
</ul>
<p>We focus further on modeling the 0/1 states and predicting probabilities. This
puts this ML exercises into the category of ML for classification.</p>
</div>
<div id="modeling-occurrence-only-records-using-random-forest" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Modeling occurrence-only records using Random Forest<a class="anchor" aria-label="anchor" href="#modeling-occurrence-only-records-using-random-forest"><i class="fas fa-link"></i></a>
</h2>
<p>Thanks to the package <code>solitude</code> it is possible to predict probability of distribution
of species by using the occurrence-only data. The method is explained in detail in
<span class="citation">Liu, Ting, &amp; Zhou (<a href="references.html#ref-liu2012isolation" role="doc-biblioref">2012</a>)</span> and <span class="citation">Hariri, Kind, &amp; Brunner (<a href="references.html#ref-hariri2019extended" role="doc-biblioref">2019</a>)</span>. Solitude builds on top of the <code>ranger</code> package hence it is suitable
also for larger datasets. To fit the model we do not need to specify any target
column but we ONLY specify a matrix of covariates at occurrence locations:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/talegari/solitude">solitude</a></span><span class="op">)</span>
<span class="va">occ.ov</span> <span class="op">=</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">occ.sp</span>, <span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>
<span class="va">occ.ov</span> <span class="op">=</span> <span class="va">occ.ov</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">occ.ov</span><span class="op">)</span>,<span class="op">]</span>
<span class="co">#head(occ.ov)</span>
<span class="va">iso</span> <span class="op">=</span> <span class="va"><a href="https://rdrr.io/pkg/solitude/man/isolationForest.html">isolationForest</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>
<span class="va">iso</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>dataset <span class="op">=</span> <span class="va">occ.ov</span><span class="op">)</span>
<span class="co">#&gt; INFO  [17:20:17.688] dataset has duplicated rows </span>
<span class="co">#&gt; INFO  [17:20:17.734] Building Isolation Forest ...  </span>
<span class="co">#&gt; INFO  [17:20:17.822] done </span>
<span class="co">#&gt; INFO  [17:20:17.824] Computing depth of terminal nodes ...  </span>
<span class="co">#&gt; INFO  [17:20:18.396] done </span>
<span class="co">#&gt; INFO  [17:20:18.653] Completed growing isolation forest</span></code></pre></div>
<p>The fitted model shows:</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iso</span><span class="op">$</span><span class="va">forest</span>
<span class="co">#&gt; Ranger result</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  ranger::ranger(x = dataset, y = yy, mtry = ncol(dataset) - 1L,      min.node.size = 1L, splitrule = "extratrees", num.random.splits = 1L,      num.trees = self$num_trees, replace = self$replace, sample.fraction = private$sample_fraction,      respect.unordered.factors = self$respect_unordered_factors,      num.threads = self$nproc, seed = self$seed, max.depth = self$max_depth) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Type:                             Regression </span>
<span class="co">#&gt; Number of trees:                  100 </span>
<span class="co">#&gt; Sample size:                      9253 </span>
<span class="co">#&gt; Number of independent variables:  12 </span>
<span class="co">#&gt; Mtry:                             11 </span>
<span class="co">#&gt; Target node size:                 1 </span>
<span class="co">#&gt; Variable importance mode:         none </span>
<span class="co">#&gt; Splitrule:                        extratrees </span>
<span class="co">#&gt; Number of random splits:          1 </span>
<span class="co">#&gt; OOB prediction error (MSE):       7183789 </span>
<span class="co">#&gt; R squared (OOB):                  -0.006752571</span></code></pre></div>
<p>These numbers are somewhat difficult to interpret with R-square being close to 0.
We can produce predictions of the anomaly scores (the likelihood that a point is an outlier)
for every location based on the fitted model using:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred.iso</span> <span class="op">=</span> <span class="va">iso</span><span class="op">$</span><span class="fu">predict</span><span class="op">(</span>data<span class="op">=</span><span class="va">g4km.spc</span><span class="op">@</span><span class="va">predicted</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span><span class="op">)</span>
<span class="va">g4km</span><span class="op">$</span><span class="va">anomaly_score</span> <span class="op">=</span> <span class="va">pred.iso</span><span class="op">$</span><span class="va">anomaly_score</span><span class="op">*</span><span class="fl">100</span>
<span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">g4km</span><span class="op">[</span><span class="st">"anomaly_score"</span><span class="op">]</span>, <span class="st">"./output/aedes_anomaly_score_4km.tif"</span>, type<span class="op">=</span><span class="st">"Int16"</span>, 
          mvFlag<span class="op">=</span><span class="op">-</span><span class="fl">32768</span>, options<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>this gives the following output:</p>
<div class="figure" style="text-align: center">
<span id="fig:solitude-eu"></span>
<img src="img/Fig_solitude_anomaly_tiger_mosquito_preview.jpg" alt="Predicted anomaly score based on the solitude package for the Tiger mosquito. Red values indicate low anomaly." width="80%"><p class="caption">
Figure 5.4: Predicted anomaly score based on the solitude package for the Tiger mosquito. Red values indicate low anomaly.
</p>
</div>
<p>In general there seems to be a large difference in the outputs (spatial patterns) of <code>maxlike</code> and <code>solitude</code>,
nevertheless the predictions seem to show overall similar patterns: both <code>maxlike</code> and
<code>solitude</code> predict that the temperature regime seem to be the most
limiting factor for the Tiger mosquito. Note, however, that <code>solitude</code> by default only returns
anomaly scores, which are abstract and should not be interpreted as probability of occurrence at all.</p>
</div>
<div id="modeling-distribution-of-mosquitos-through-time" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Modeling distribution of mosquitos through time<a class="anchor" aria-label="anchor" href="#modeling-distribution-of-mosquitos-through-time"><i class="fas fa-link"></i></a>
</h2>
<p>Next we can overlay training points (occurrences / adult counts and pseudo-absences)
in spacetime to produce a spatiotemporal regression-matrix. The total list of
layers for Europe (MOOD Horizon 2020 project) available as <a href="https://av.tib.eu/media/55228">Cloud-Optimized GeoTIFFs</a>
is documented in:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cov.lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"./input/mood_layers1km.csv"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">cov.lst</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    454 obs. of  5 variables:</span>
<span class="co">#&gt;  $ n          : int  1 2 3 4 5 6 7 8 9 10 ...</span>
<span class="co">#&gt;  $ filename   : chr  "https://s3.eu-central-1.wasabisys.com/mood/CRP/lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2000_mood_v0.1.tif" "https://s3.eu-central-1.wasabisys.com/mood/CRP/lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.tif" "https://s3.eu-central-1.wasabisys.com/mood/CRP/lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2002_mood_v0.1.tif" "https://s3.eu-central-1.wasabisys.com/mood/CRP/lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2003_mood_v0.1.tif" ...</span>
<span class="co">#&gt;  $ size       : chr  "9.7 Mb" "9.7 Mb" "9.7 Mb" "9.8 Mb" ...</span>
<span class="co">#&gt;  $ source_doi : chr  "http://doi.org/10.5194/essd-13-5403-2021" "http://doi.org/10.5194/essd-13-5403-2021" "http://doi.org/10.5194/essd-13-5403-2021" "http://doi.org/10.5194/essd-13-5403-2021" ...</span>
<span class="co">#&gt;  $ description: chr  "Cropland fraction historic" "Cropland fraction historic" "Cropland fraction historic" "Cropland fraction historic" ...</span></code></pre></div>
<p>To connect to the layers and extract values at point locations we can use:</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra">terra</a></span><span class="op">)</span>
<span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"/vsicurl/"</span>, <span class="va">cov.lst</span><span class="op">$</span><span class="va">filename</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span>
<span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Message</span>
<span class="co">#&gt; 1: HTTP response code on https://s3.eu-central-1.wasabisys.com/mood/CRP/</span>
<span class="co">#&gt; lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.tif.aux.xml: 403</span>
<span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Message</span>
<span class="co">#&gt; 1: HTTP response code on https://s3.eu-central-1.wasabisys.com/mood/CRP/</span>
<span class="co">#&gt; lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.aux: 403</span>
<span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Message</span>
<span class="co">#&gt; 1: HTTP response code on https://s3.eu-central-1.wasabisys.com/mood/CRP/</span>
<span class="co">#&gt; lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.AUX: 403</span>
<span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Message</span>
<span class="co">#&gt; 1: HTTP response code on https://s3.eu-central-1.wasabisys.com/mood/CRP/</span>
<span class="co">#&gt; lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.tif.aux: 403</span>
<span class="co">#&gt; Warning in new_CppObject_xp(fields$.module, fields$.pointer, ...): GDAL Message</span>
<span class="co">#&gt; 1: HTTP response code on https://s3.eu-central-1.wasabisys.com/mood/CRP/</span>
<span class="co">#&gt; lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.tif.AUX: 403</span>
<span class="va">r</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 7360, 7845, 1  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 1000, 1000  (x, y)</span>
<span class="co">#&gt; extent      : 867000, 8712000, -484000, 6876000  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs </span>
<span class="co">#&gt; data source : lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1.tif </span>
<span class="co">#&gt; names       : lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1</span></code></pre></div>
<p>To get values of pixels at some location we can fetch values without downloading
the complete rasters e.g.:</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">3828332</span>, y<span class="op">=</span><span class="fl">2315068</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;      ID lcv_globalcropland_bowen.et.al_p_1km_s0..0cm_2001_mood_v0.1</span>
<span class="co">#&gt; [1,]  1                                                          24</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:qgis-cogs"></span>
<img src="img/mood_COG_files_QGIS.gif" alt="Opening Cloud-Optimized GeoTIFF layers in QGIS. The total size of layers exceeds 30GB so it is more efficient to access data using the COG-architecture and S3 services." width="90%"><p class="caption">
Figure 5.5: Opening Cloud-Optimized GeoTIFF layers in QGIS. The total size of layers exceeds 30GB so it is more efficient to access data using the COG-architecture and S3 services.
</p>
</div>
<p>The spacetime overlay process can be computational hence we have already pre-computed
the regression / classification matrix:</p>
<div class="sourceCode" id="cb125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"mood_functions.R"</span><span class="op">)</span>
<span class="va">rm.all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/regmatrix_aedes_1km.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">dim</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">)</span>
<span class="co">#&gt; [1] 18234   183</span></code></pre></div>
<p>This is now a relatively large matrix with basically diversity of Earth Observation
and climatic time-series of images. We can define the model as classification problem
where occurrence/absence values (0/1) are two states of the target variable:</p>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rm.all</span><span class="op">$</span><span class="va">occurrence</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/factors.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">$</span><span class="va">individualCount</span><span class="op">&gt;</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">$</span><span class="va">occurrence</span><span class="op">)</span>
<span class="co">#&gt;     0     1 </span>
<span class="co">#&gt;  4400 13834</span></code></pre></div>
<p>and which we model as a function of number of static and dynamic covariate layers:</p>
<div class="sourceCode" id="cb127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sel.stat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span><span class="op">(</span><span class="st">"4km"</span>, <span class="st">"1km"</span>, <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html">file_path_sans_ext</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">eco.tifs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
             <span class="st">"dtm_twi_merit.dem_m_1km_s0..0cm_2017_mood_v1"</span>,
             <span class="st">"dtm_floodmap.500y_jrc.hazardmapping_m_1km_s0..0cm_1500..2016_mood_v1.0"</span>,
             <span class="st">"dtm_slope_merit.dem_m_1km_s0..0cm_2017_mood_v1"</span>,
             <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"adm_travel.time.to.cities.cl"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="st">"_cgiar_m_1km_s0..0cm_2000..2020_mood_v1"</span><span class="op">)</span>,
             <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"adm_travel.time.to.ports.cl"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"_cgiar_m_1km_s0..0cm_2000..2020_mood_v1"</span><span class="op">)</span><span class="op">)</span>
<span class="va">pr.vars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="va">sel.stat</span>,  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"CRP"</span>, <span class="st">"FOR"</span>, <span class="st">"HFP"</span>, <span class="st">"LST"</span>, <span class="st">"N02"</span>, <span class="st">"N08"</span>, <span class="st">"NLT"</span>, <span class="st">"PPD"</span>, <span class="st">"PRE"</span>, <span class="st">"SNW"</span>, <span class="st">"T02"</span>, <span class="st">"T08"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fm.fs</span> <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"occurrence ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">pr.vars</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">fm.fs</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;  chr [1:45] "occurrence" ...</span></code></pre></div>
<p>Next, we fit an Ensemble ML model to predict spatiotemporal distribution of species
for 2000–2021 period by following the basic steps:</p>
<ol style="list-style-type: decimal">
<li>Fine-tune hyperparameters per base learner (using a smaller subset);<br>
</li>
<li>Fit the stacked learner using optimized parameters;<br>
</li>
<li>Generate predictions for the time-series of interest;</li>
</ol>
<p>The steps can be run using functions we created and which extend the mlr package:</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'dplyr'</span>
<span class="co">#&gt; The following object is masked from 'package:matrixStats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     count</span>
<span class="co">#&gt; The following objects are masked from 'package:terra':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     collapse, select</span>
<span class="co">#&gt; The following objects are masked from 'package:raster':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, select, union</span>
<span class="co">#&gt; The following objects are masked from 'package:stats':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     filter, lag</span>
<span class="co">#&gt; The following objects are masked from 'package:base':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     intersect, setdiff, setequal, union</span>
<span class="va">fs.rm0</span> <span class="op">=</span> <span class="va">rm.all</span> <span class="op"><a href="https://rdrr.io/pkg/magrittr/man/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/sample_n.html">sample_n</a></span><span class="op">(</span><span class="fl">5000</span><span class="op">)</span>
<span class="va">f</span> <span class="op">=</span> <span class="st">"./output/aedes/"</span>
<span class="va">tnd.ml</span> <span class="op">=</span> <span class="fu">tune_learners</span><span class="op">(</span>data <span class="op">=</span> <span class="va">fs.rm0</span>, formula <span class="op">=</span> <span class="va">fm.fs</span>, 
                      blocking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">fs.rm0</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span>, out.dir<span class="op">=</span><span class="va">f</span><span class="op">)</span>
<span class="co">#&gt; Using learners: classif.ranger, classif.xgboost, classif.glmnet...TRUE</span>
<span class="va">t.m</span> <span class="op">=</span> <span class="fu">train_sp_eml</span><span class="op">(</span>data <span class="op">=</span> <span class="va">rm.all</span>, tune_result <span class="op">=</span> <span class="va">tnd.ml</span>, 
                   blocking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/factors.html">as.factor</a></span><span class="op">(</span><span class="va">rm.all</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span>, out.dir <span class="op">=</span> <span class="va">f</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">t.m</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::glm(formula = f, family = "binomial", data = getTaskData(.task, </span>
<span class="co">#&gt;     .subset), weights = .weights, model = FALSE)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Deviance Residuals: </span>
<span class="co">#&gt;     Min       1Q   Median       3Q      Max  </span>
<span class="co">#&gt; -3.2362   0.0986   0.0986   0.0986   4.2849  </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                 Estimate Std. Error z value Pr(&gt;|z|)    </span>
<span class="co">#&gt; (Intercept)     -12.0872     0.5069 -23.844  &lt; 2e-16 ***</span>
<span class="co">#&gt; classif.ranger   14.4862     0.7916  18.301  &lt; 2e-16 ***</span>
<span class="co">#&gt; classif.xgboost   1.0373     0.4281   2.423   0.0154 *  </span>
<span class="co">#&gt; classif.glmnet    1.8872     0.3742   5.043 4.58e-07 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; (Dispersion parameter for binomial family taken to be 1)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     Null deviance: 18985.9  on 17505  degrees of freedom</span>
<span class="co">#&gt; Residual deviance:  1192.9  on 17502  degrees of freedom</span>
<span class="co">#&gt; AIC: 1200.9</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Number of Fisher Scoring iterations: 9</span></code></pre></div>
<p>which shows the model is significant with errors in probability space ranging from -0.08 to 0.12.
The most important variables based on the variable importance functionality of the random forest seem to be:</p>
<div class="sourceCode" id="cb129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/getFeatureImportance.html">getFeatureImportance</a></span><span class="op">(</span><span class="va">t.m</span><span class="op">[[</span><span class="st">"learner.model"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"base.models"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">res</span><span class="op">)</span>
<span class="va">xl</span><span class="op">$</span><span class="va">relative_importance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="va">xl</span><span class="op">$</span><span class="va">importance</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">xl</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
<span class="va">xl</span> <span class="op">=</span> <span class="va">xl</span><span class="op">[</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html">order</a></span><span class="op">(</span><span class="va">xl</span><span class="op">$</span><span class="va">relative_importance</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">xl</span><span class="op">$</span><span class="va">variable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">length</a></span><span class="op">(</span><span class="va">t.m</span><span class="op">$</span><span class="va">features</span><span class="op">)</span><span class="op">)</span>, <span class="st">". "</span>, <span class="va">xl</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>
<span class="va">xl</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,<span class="op">]</span>
<span class="co">#&gt;                                                                    variable</span>
<span class="co">#&gt; 40                                                                   1. NLT</span>
<span class="co">#&gt; 27 2. adm_travel.time.to.cities.cl10_cgiar_m_1km_s0..0cm_2000..2020_mood_v1</span>
<span class="co">#&gt; 26  3. adm_travel.time.to.cities.cl9_cgiar_m_1km_s0..0cm_2000..2020_mood_v1</span>
<span class="co">#&gt; 31   4. adm_travel.time.to.ports.cl4_cgiar_m_1km_s0..0cm_2000..2020_mood_v1</span>
<span class="co">#&gt; 24  5. adm_travel.time.to.cities.cl7_cgiar_m_1km_s0..0cm_2000..2020_mood_v1</span>
<span class="co">#&gt; 41                                                                   6. PPD</span>
<span class="co">#&gt; 32   7. adm_travel.time.to.ports.cl5_cgiar_m_1km_s0..0cm_2000..2020_mood_v1</span>
<span class="co">#&gt; 9        8. clm_bioclim.1_chelsa.climate_m_1km_s0..0cm_1980..2010_mood_v2.1</span>
<span class="co">#&gt;    importance relative_importance</span>
<span class="co">#&gt; 40  1342.8258                21.5</span>
<span class="co">#&gt; 27  1030.3510                16.5</span>
<span class="co">#&gt; 26   692.6710                11.1</span>
<span class="co">#&gt; 31   639.9700                10.3</span>
<span class="co">#&gt; 24   445.3388                 7.1</span>
<span class="co">#&gt; 41   419.0600                 6.7</span>
<span class="co">#&gt; 32   181.0785                 2.9</span>
<span class="co">#&gt; 9    177.5123                 2.8</span></code></pre></div>
<ul>
<li>Night lights (NLT) based on <span class="citation">Li, Zhou, Zhao, &amp; Zhao (<a href="references.html#ref-li2020harmonized" role="doc-biblioref">2020</a>)</span>;<br>
</li>
<li>Travel time to cities and ports based on <span class="citation">Nelson et al. (<a href="references.html#ref-nelson2019suite" role="doc-biblioref">2019</a>)</span>;<br>
</li>
<li>Population density (PPD) based on <a href="https://doi.org/10.7927/H49C6VHW">Gridded Population of the World (GPW), v4</a>;<br>
</li>
<li>Night time images based on <a href="https://doi.org/10.5281/zenodo.1420114">MOD11A2</a>;<br>
</li>
<li>Human Footprint dataset based on <span class="citation">Mu et al. (<a href="references.html#ref-mu2022global" role="doc-biblioref">2022</a>)</span>;</li>
</ul>
</div>
<div id="generating-the-trend-maps" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Generating the trend maps<a class="anchor" aria-label="anchor" href="#generating-the-trend-maps"><i class="fas fa-link"></i></a>
</h2>
<p>After we have produced predictions for Europe for mosquito occurrence we can also
stack them and visualize them as animation:</p>
<div class="figure" style="text-align: center">
<span id="fig:qgis-vis"></span>
<img src="img/tiger_mosquito_europe_2000_2021_probs.gif" alt="Spatiotemporal visualization of the predicted occurrence probability for the Tiger mosquito with a Zoom in on Spain." width="90%"><p class="caption">
Figure 5.6: Spatiotemporal visualization of the predicted occurrence probability for the Tiger mosquito with a Zoom in on Spain.
</p>
</div>
<p>we can also derive beta coefficient per pixel using the <a href="https://greenbrown.r-forge.r-project.org/">greenbrown package</a> to see
if some parts of Europe are showing higher increase in mosquito density. Example with predictions for Spain:</p>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>; <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="va">es.tifs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"./output/spain1km"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html">glob2rx</a></span><span class="op">(</span><span class="st">"aedes.albopictus_M_*.tif"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">spain1km</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html">brick</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">es.tifs</span><span class="op">)</span><span class="op">)</span>
<span class="co">#spplot(spain1km[[c(1,22)]], col.regions=SAGA_pal[[10]])</span></code></pre></div>
<div class="sourceCode" id="cb131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#install.packages("greenbrown", repos="http://R-Forge.R-project.org")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">greenbrown</span><span class="op">)</span>
<span class="va">trendmap</span> <span class="op">&lt;-</span> <span class="fu">TrendRaster</span><span class="op">(</span><span class="va">spain1km</span>, start<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="fl">1</span><span class="op">)</span>, freq<span class="op">=</span><span class="fl">1</span>, breaks<span class="op">=</span><span class="fl">1</span><span class="op">)</span> 
<span class="co">## can be computationally intensive</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">trendmap</span><span class="op">[[</span><span class="st">"SlopeSEG1"</span><span class="op">]</span><span class="op">]</span>, 
     col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="st">"SG_COLORS_GREEN_GREY_RED"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
     zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>,<span class="fl">1.5</span><span class="op">)</span>, main<span class="op">=</span><span class="st">"Slope SEG1"</span><span class="op">)</span></code></pre></div>
<p>Alternatively, we can also derive beta coefficient using parallelization and <code>lm</code> function.
This basically fits model for every time-series of pixels and returns a vector.</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">spain1km</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span>
<span class="va">in.years</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">es.tifs</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/tstrsplit.html">strsplit</a></span><span class="op">(</span><span class="va">i</span>, <span class="st">"_"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">}</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"in.years"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## select ONLY pixels that change in time</span>
<span class="va">sd.pix</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parApply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">xs</span><span class="op">@</span><span class="va">data</span>, <span class="fl">1</span>, <span class="va">sd</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">==</span><span class="fl">0</span><span class="op">)</span>
<span class="co">## derive beta per pixel:</span>
<span class="co">## Because probs are binary variable we use logit transformation</span>
<span class="va">betas</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">parApply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">xs</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">sd.pix</span>,<span class="op">]</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span> 
  <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">in.years</span>, 
    y<span class="op">=</span><span class="fu">boot</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/logit.html">logit</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">&lt;=</span><span class="fl">0</span>, <span class="fl">0.1</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">&gt;=</span><span class="fl">100</span>, <span class="fl">99.9</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span><span class="fl">1000</span> <span class="op">)</span> 
    <span class="op">)</span> <span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co">## write to GeoTIF</span>
<span class="va">spain.trend</span> <span class="op">=</span> <span class="va">xs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="va">spain.trend</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
<span class="va">spain.trend</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">sd.pix</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span>
<span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">spain.trend</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"./output/spain_trend_aedes_1km.tif"</span>, type<span class="op">=</span><span class="st">"Int16"</span>, 
          mvFlag<span class="op">=</span><span class="op">-</span><span class="fl">32768</span>, options<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:betas-map"></span>
<img src="img/spain_eades_trend.map.png" alt="Trend map for mosquito distribution through time. Red color indicates increase in occurrence probability, blue color decrease." width="90%"><p class="caption">
Figure 5.7: Trend map for mosquito distribution through time. Red color indicates increase in occurrence probability, blue color decrease.
</p>
</div>
</div>
<div id="summary" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Summary<a class="anchor" aria-label="anchor" href="#summary"><i class="fas fa-link"></i></a>
</h2>
<p>In this chapter we demonstrate how to use occurrence-only records to map distribution of target species in spacetime.
We again use Ensemble Machine Learning on training data overlaid in spacetime vs time-series
of Night Light, vegetation, climatic images (years 2000–2021). The training data is
limited to <a href="https://datastudio.google.com/reporting/ae84bde2-a200-4254-bdd0-017f08a8baa7">occurrence-only records</a> and these are neither based on probability sampling
nor a consistent in time. Probably more suited training data set would have been if for example
meteorological stations across EU have recorded daily records of mosquito occurrence (0/1).
Having a systematic records at dense and well distributed locations across Europe would be
the perfect data set for this exercise, but even with using limited GBIF records we are
able to produce relatively accurate maps of probability of occurrence.</p>
<p>Note that in the case study above, we could have also used time i.e. Year of observation
as a covariate. If we would add Year as covariate to this training point data, then predictions
would have probably shown that probability of occurrence is increasing significantly in the recent years.
This does not necessarily has to match reality on the ground. Just because there
are more records of the mosquito species for more recent years, that does not mean
that the mosquito has appeared in recent years. In fact, if we would use Year as a covariate
with this data, we would most likely introduce a bias in predictions <span class="citation">(<a href="references.html#ref-syfert2013effects" role="doc-biblioref">Syfert, Smith, &amp; Coomes, 2013</a>)</span>.</p>
<p>GBIF data is of course of limited use for SDM and comes with often misssing meta-information
and has, of course, huge gaps <span class="citation">(<a href="references.html#ref-Marcer2022" role="doc-biblioref">Marcer et al., 2022</a>; <a href="references.html#ref-syfert2013effects" role="doc-biblioref">Syfert et al., 2013</a>)</span>. This does not means that also the
analysis in this tutorial is flawed or should not be considered as trust-worthy;
it only means that running any spatial analysis on GBIF data should be done with
care and aiming at correct interpretation.</p>
<p>The simple alternative to derive (kernel) density maps of mosquitos for Europe
would be to use the <code><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">sparr::spattemp.density</a></code> function:</p>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">st.f</span> <span class="op">=</span> <span class="va">occ</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>,<span class="st">"decimalLatitude"</span>,<span class="st">"Date"</span>,<span class="st">"individualCount"</span><span class="op">)</span><span class="op">]</span>
<span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/fifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">st.f</span><span class="op">$</span><span class="va">individualCount</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"decimalLongitude"</span>, <span class="st">"decimalLatitude"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">st.f</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:4326"</span><span class="op">)</span>
<span class="va">grid1d</span> <span class="op">=</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"./input/mask_5km.tif"</span><span class="op">)</span>
<span class="va">grid1d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">grid1d</span>, <span class="st">"SpatialPixelsDataFrame"</span><span class="op">)</span>
<span class="va">te</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">grid1d</span><span class="op">@</span><span class="va">bbox</span><span class="op">)</span>
<span class="co">#plot(grid1d)</span>
<span class="va">mg_owin</span> <span class="op">&lt;-</span> <span class="fu">spatstat.geom</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/spatstat.geom/man/as.owin.html">as.owin</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">grid1d</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">grid1d</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, window <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">st.f_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html">spTransform</a></span><span class="op">(</span><span class="va">st.f</span>, <span class="va">grid1d</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span>
<span class="va">pp</span> <span class="op">=</span> <span class="fu">ppp</span><span class="op">(</span>x<span class="op">=</span><span class="va">st.f_sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, y<span class="op">=</span><span class="va">st.f_sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, marks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">st.f_sp</span><span class="op">$</span><span class="va">Date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, window <span class="op">=</span> <span class="va">mg_owin</span><span class="op">)</span>
<span class="co">## Warning messages:</span>
<span class="co">#1: 41072 points were rejected as lying outside the specified window </span>
<span class="co">#2: data contain duplicated points</span>
<span class="va">pp</span><span class="op">$</span><span class="va">n</span>
<span class="co">## 13893</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">pp</span><span class="op">$</span><span class="va">marks</span><span class="op">)</span>
<span class="co">## spacetime density ----</span>
<span class="va">eu.stgrid</span> <span class="op">=</span> <span class="fu">sparr</span><span class="fu">::</span><span class="fu"><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">spattemp.density</a></span><span class="op">(</span><span class="va">pp</span>, tt <span class="op">=</span> <span class="va">pp</span><span class="op">$</span><span class="va">marks</span>, tlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="fl">2000</span>,<span class="fl">2022</span><span class="op">)</span>, sres<span class="op">=</span><span class="fl">1569</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## Calculating trivariate smooth...Done.</span>
<span class="co">## Edge-correcting...Done.</span>
<span class="co">## Conditioning on time...Done.</span>
<span class="co">#plot(eu.stgrid, 2018)</span>
<span class="va">dmap</span> <span class="op">&lt;-</span> <span class="fu">maptools</span><span class="fu">::</span><span class="fu"><a href="http://maptools.r-forge.r-project.org/reference/as.im.html">as.SpatialGridDataFrame.im</a></span><span class="op">(</span><span class="va">eu.stgrid</span><span class="op">$</span><span class="va">z</span><span class="op">[[</span><span class="st">"2012"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">dmap</span><span class="op">$</span><span class="va">v</span><span class="op">*</span><span class="fl">1e12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">dmap</span><span class="op">)</span></code></pre></div>
<p>The problem of usiong <code><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">sparr::spattemp.density</a></code> is that (a) it can be used
only with occurrence only records, (b) it assumes that ALL or systematically
sampled occurrences of the phenomena are available.
If this is not the case, the function <code><a href="https://tilmandavies.github.io/sparr/reference/spattemp.density.html">sparr::spattemp.density</a></code> would also probably produce a biased
estimate of the distribution of mosquitos through time.</p>
<p>Ensemble Machine Learning we used to generate predictions helps produce unbiased estimate of
mosquito occurrences over Europe for a time-series of years. The disadvantages of using
spatiotemporal ML are:</p>
<ul>
<li>We are correlating the Earth Observation data with mosquito density, but mosquitos
are dynamic and can not be sensed / seen from space, at least not at 1km resolution;
we have to rely on correlation with environmental factors and this can explain only smaller part of variation;<br>
</li>
<li>We assume that the GBIF training points are representative for various environmental
conditions, while in practice less training data is available for physically distant
areas e.g. mountains (hence these training data can be considered to be <strong>censored</strong>);</li>
<li>Predictions produced in this example come with relatively high errors in extrapolation
areas, so the predictions should be used together with the uncertainty maps;</li>
</ul>
</div>
<div id="acknowledgments" class="section level2" number="5.8">
<h2>
<span class="header-section-number">5.8</span> Acknowledgments<a class="anchor" aria-label="anchor" href="#acknowledgments"><i class="fas fa-link"></i></a>
</h2>
<p>This project has received funding from the European Union’s Horizon 2020 Research and innovation programme under <a href="https://cordis.europa.eu/project/id/874850">grant agreement No 874850</a>.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="spatiotemporal-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></div>
<div class="next"><a href="spatiotemporal-prediction-of-soil-organic-carbon.html"><span class="header-section-number">6</span> Spatiotemporal prediction of Soil Organic Carbon</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatiotemporal-machine-learning-for-species-distribution-modeling"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="nav-link" href="#species-distribution-modeling"><span class="header-section-number">5.1</span> Species Distribution Modeling</a></li>
<li><a class="nav-link" href="#tiger-mosquito-over-europe"><span class="header-section-number">5.2</span> Tiger Mosquito over Europe</a></li>
<li><a class="nav-link" href="#generating-pseudo-absence-data"><span class="header-section-number">5.3</span> Generating pseudo-absence data</a></li>
<li><a class="nav-link" href="#modeling-occurrence-only-records-using-random-forest"><span class="header-section-number">5.4</span> Modeling occurrence-only records using Random Forest</a></li>
<li><a class="nav-link" href="#modeling-distribution-of-mosquitos-through-time"><span class="header-section-number">5.5</span> Modeling distribution of mosquitos through time</a></li>
<li><a class="nav-link" href="#generating-the-trend-maps"><span class="header-section-number">5.6</span> Generating the trend maps</a></li>
<li><a class="nav-link" href="#summary"><span class="header-section-number">5.7</span> Summary</a></li>
<li><a class="nav-link" href="#acknowledgments"><span class="header-section-number">5.8</span> Acknowledgments</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OpenGeoHub/spatial-prediction-eml/blob/master/spatiotemporal-sdm.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OpenGeoHub/spatial-prediction-eml/edit/master/spatiotemporal-sdm.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spatial and spatiotemporal interpolation using Ensemble Machine Learning</strong>" was written by Tom Hengl, Leandro Parente, Carmelo Bonannella and contributors. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
