<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2 Spatial interpolation using Ensemble ML | Spatial and spatiotemporal interpolation using Ensemble Machine Learning</title>
<meta name="author" content="Tom Hengl, Leandro Parente and Carmelo Bonannella">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.8.1/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BH6J2NKGP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1BH6J2NKGP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spatial and spatiotemporal interpolation using Ensemble Machine Learning</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></li>
<li><a class="active" href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="" href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-interpolation-using-ensemble-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></li>
<li><a class="" href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">5</span> Multi-scale spatial prediction models</a></li>
<li><a class="" href="summary.html"><span class="header-section-number">6</span> Summary</a></li>
<li><a class="" href="references.html"><span class="header-section-number">7</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OpenGeoHub/spatial-prediction-eml">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatial-interpolation-using-ensemble-ml" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Spatial interpolation using Ensemble ML<a class="anchor" aria-label="anchor" href="#spatial-interpolation-using-ensemble-ml"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<p>You are reading the work-in-progress Spatial and spatiotemporal interpolation using Ensemble Machine Learning. This chapter is currently draft version, a peer-review publication is pending. You can find the polished first edition at <a href="https://opengeohub.github.io/spatial-prediction-eml/" class="uri">https://opengeohub.github.io/spatial-prediction-eml/</a>.</p>
</div>
<div id="spatial-interpolation-using-ml-and-buffer-distances-to-points" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Spatial interpolation using ML and buffer distances to points<a class="anchor" aria-label="anchor" href="#spatial-interpolation-using-ml-and-buffer-distances-to-points"><i class="fas fa-link"></i></a>
</h2>
<p>A relatively simple approach to interpolate values from point data using e.g. 
Random Forest is to use <strong>buffer distances</strong> to all points as covariates. We can
here use the meuse dataset for testing <span class="citation">(<a href="references.html#ref-hengl2018random" role="doc-biblioref">T. Hengl, Nussbaum, Wright, Heuvelink, &amp; Gräler, 2018</a>)</span>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://rgdal.r-forge.r-project.org">rgdal</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/imbs-hl/ranger">ranger</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/demo.html">demo</a></span><span class="op">(</span><span class="va">meuse</span>, echo<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">grid.dist0</span> <span class="op">&lt;-</span> <span class="fu">landmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/landmap/man/buffer.dist-methods.html">buffer.dist</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="st">"zinc"</span><span class="op">]</span>, <span class="va">meuse.grid</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, 
                                   classes<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This creates 155 gridded maps i.e. one map per training point. These maps of
distances can now be used to predict some target variable by running:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dn0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">grid.dist0</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>
<span class="va">fm0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"zinc ~ "</span>, <span class="va">dn0</span><span class="op">)</span><span class="op">)</span>
<span class="va">ov.zinc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="st">"zinc"</span><span class="op">]</span>, <span class="va">grid.dist0</span><span class="op">)</span>
<span class="va">rm.zinc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="st">"zinc"</span><span class="op">]</span>, <span class="va">ov.zinc</span><span class="op">)</span>
<span class="va">m.zinc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span><span class="va">fm0</span>, <span class="va">rm.zinc</span>, num.trees<span class="op">=</span><span class="fl">150</span>, seed<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="va">m.zinc</span>
<span class="co">#&gt; Ranger result</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  ranger(fm0, rm.zinc, num.trees = 150, seed = 1) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Type:                             Regression </span>
<span class="co">#&gt; Number of trees:                  150 </span>
<span class="co">#&gt; Sample size:                      155 </span>
<span class="co">#&gt; Number of independent variables:  155 </span>
<span class="co">#&gt; Mtry:                             12 </span>
<span class="co">#&gt; Target node size:                 5 </span>
<span class="co">#&gt; Variable importance mode:         none </span>
<span class="co">#&gt; Splitrule:                        variance </span>
<span class="co">#&gt; OOB prediction error (MSE):       67501.48 </span>
<span class="co">#&gt; R squared (OOB):                  0.4990359</span></code></pre></div>
<p>Using this model we can generate and plot predictions using:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>oma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="va">zinc.rfd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m.zinc</span>, <span class="va">grid.dist0</span><span class="op">@</span><span class="va">data</span><span class="op">)</span><span class="op">$</span><span class="va">predictions</span>
<span class="va">meuse.grid</span><span class="op">$</span><span class="va">zinc.rfd</span> <span class="op">=</span> <span class="va">zinc.rfd</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">meuse.grid</span><span class="op">[</span><span class="st">"zinc.rfd"</span><span class="op">]</span><span class="op">)</span>, col<span class="op">=</span><span class="va">R_pal</span><span class="op">[[</span><span class="st">"rainbow_75"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span>,
         main<span class="op">=</span><span class="st">"Predictions RF on buffer distances"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">meuse</span>, pch<span class="op">=</span><span class="st">"+"</span>, cex<span class="op">=</span><span class="fl">.8</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-buff"></span>
<img src="spatial-interpolation_files/figure-html/map-buff-1.png" alt="Values of Zinc predicted using only RF on buffer distances." width="100%"><p class="caption">
Figure 2.1: Values of Zinc predicted using only RF on buffer distances.
</p>
</div>
<p>The resulting predictions produce patterns very much similar to what we would
produce if we have used ordinary kriging or similar. Note however that for RFsp
model: (1) we did not have to fit any variogram, (2) the model is in essence <em>over-
parameterized</em> with basically more covariates than training points.</p>
</div>
<div id="spatial-interpolation-using-ml-and-geographical-distances-to-neighbors" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Spatial interpolation using ML and geographical distances to neighbors<a class="anchor" aria-label="anchor" href="#spatial-interpolation-using-ml-and-geographical-distances-to-neighbors"><i class="fas fa-link"></i></a>
</h2>
<p>Deriving buffer distances for all points is obviously not suitable for very
large point datasets. <span class="citation"><a href="references.html#ref-sekulic2020random" role="doc-biblioref">Sekulić, Kilibarda, Heuvelink, Nikolić, &amp; Bajat</a> (<a href="references.html#ref-sekulic2020random" role="doc-biblioref">2020</a>)</span> describe an alternative, a more scalable
method that uses closest neighbors (and their values) as covariates to predict
target variable. This can be implemented using the <code>meteo</code> package:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://meteo.r-forge.r-project.org/">meteo</a></span><span class="op">)</span>
<span class="co">#&gt; Warning: replacing previous import 'caret::MAE' by 'DescTools::MAE' when loading</span>
<span class="co">#&gt; 'meteo'</span>
<span class="co">#&gt; Warning: replacing previous import 'caret::RMSE' by 'DescTools::RMSE' when</span>
<span class="co">#&gt; loading 'meteo'</span>
<span class="va">nearest_obs</span> <span class="op">&lt;-</span> <span class="fu">meteo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/meteo/man/near.obs.html">near.obs</a></span><span class="op">(</span>locations <span class="op">=</span> <span class="va">meuse.grid</span>, 
                               locations.x.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, 
                               observations <span class="op">=</span> <span class="va">meuse</span>, observations.x.y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, 
                               zcol <span class="op">=</span> <span class="st">"zinc"</span>, n.obs <span class="op">=</span> <span class="fl">10</span>, rm.dupl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Warning in if (class(knn1$nn.idx) != "integer") {: the condition has length &gt; 1</span>
<span class="co">#&gt; and only the first element will be used</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">nearest_obs</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    3103 obs. of  20 variables:</span>
<span class="co">#&gt;  $ dist1 : num  168.2 112 139.9 172 56.4 ...</span>
<span class="co">#&gt;  $ dist2 : num  204 165 164 173 127 ...</span>
<span class="co">#&gt;  $ dist3 : num  239 183 210 230 139 ...</span>
<span class="co">#&gt;  $ dist4 : num  282 268 246 241 265 ...</span>
<span class="co">#&gt;  $ dist5 : num  370 331 330 335 297 ...</span>
<span class="co">#&gt;  $ dist6 : num  407 355 370 380 306 ...</span>
<span class="co">#&gt;  $ dist7 : num  429 406 391 388 390 ...</span>
<span class="co">#&gt;  $ dist8 : num  504 448 473 472 393 ...</span>
<span class="co">#&gt;  $ dist9 : num  523 476 484 496 429 ...</span>
<span class="co">#&gt;  $ dist10: num  524 480 488 497 431 ...</span>
<span class="co">#&gt;  $ obs1  : num  1022 1022 1022 640 1022 ...</span>
<span class="co">#&gt;  $ obs2  : num  640 640 640 1022 1141 ...</span>
<span class="co">#&gt;  $ obs3  : num  1141 1141 1141 257 640 ...</span>
<span class="co">#&gt;  $ obs4  : num  257 257 257 1141 257 ...</span>
<span class="co">#&gt;  $ obs5  : num  346 346 346 346 346 346 346 346 346 346 ...</span>
<span class="co">#&gt;  $ obs6  : num  406 406 406 269 406 406 406 269 257 406 ...</span>
<span class="co">#&gt;  $ obs7  : num  269 269 269 406 269 ...</span>
<span class="co">#&gt;  $ obs8  : num  1096 1096 1096 281 1096 ...</span>
<span class="co">#&gt;  $ obs9  : num  347 347 347 347 504 347 347 279 269 504 ...</span>
<span class="co">#&gt;  $ obs10 : num  281 504 281 279 347 504 279 347 347 347 ...</span></code></pre></div>
<p>which produces 20 grids showing assigned values from 1st to 10th
neighbor and distances. We can plot values based on the first neighbor,
which corresponds to using e.g. <a href="https://r-spatial.github.io/sf/reference/geos_unary.html">Voronoi polygons</a>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meuse.gridF</span> <span class="op">=</span> <span class="va">meuse.grid</span>
<span class="va">meuse.gridF</span><span class="op">@</span><span class="va">data</span> <span class="op">=</span> <span class="va">nearest_obs</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">meuse.gridF</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-ob1"></span>
<img src="spatial-interpolation_files/figure-html/map-ob1-1.png" alt="Values of first neighbor for meuse dataset." width="100%"><p class="caption">
Figure 2.2: Values of first neighbor for meuse dataset.
</p>
</div>
<p>Next, we can estimate the same values for training points, but this time
we remove any duplicates using <code>rm.dupl = TRUE</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## training points</span>
<span class="va">nearest_obs.dev</span> <span class="op">&lt;-</span> <span class="fu">meteo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/meteo/man/near.obs.html">near.obs</a></span><span class="op">(</span>locations <span class="op">=</span> <span class="va">meuse</span>, 
                                   locations.x.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, 
                                   observations <span class="op">=</span> <span class="va">meuse</span>, 
                                   observations.x.y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span>, 
                                   zcol <span class="op">=</span> <span class="st">"zinc"</span>, n.obs <span class="op">=</span> <span class="fl">10</span>, rm.dupl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">#&gt; Warning in if (class(knn1$nn.idx) != "integer") {: the condition has length &gt; 1</span>
<span class="co">#&gt; and only the first element will be used</span>
<span class="va">meuse</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">@</span><span class="va">data</span>, <span class="va">nearest_obs.dev</span><span class="op">)</span></code></pre></div>
<p>Finally, we can fit a model to predict values purely based on spatial
autocorrelation between values (1st to 10th nearest neighbour):</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fm.RFSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/formula.html">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"zinc ~ "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dist"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span>, <span class="st">"+"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"obs"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, collapse<span class="op">=</span><span class="st">"+"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">fm.RFSI</span>
<span class="co">#&gt; zinc ~ dist1 + dist2 + dist3 + dist4 + dist5 + dist6 + dist7 + </span>
<span class="co">#&gt;     dist8 + dist9 + dist10 + obs1 + obs2 + obs3 + obs4 + obs5 + </span>
<span class="co">#&gt;     obs6 + obs7 + obs8 + obs9 + obs10</span>
<span class="va">rf_RFSI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span><span class="va">fm.RFSI</span>, data<span class="op">=</span><span class="va">meuse</span><span class="op">@</span><span class="va">data</span>, importance <span class="op">=</span> <span class="st">"impurity"</span>, num.trees <span class="op">=</span> <span class="fl">85</span>, keep.inbag <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">rf_RFSI</span>
<span class="co">#&gt; Ranger result</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  ranger(fm.RFSI, data = meuse@data, importance = "impurity", num.trees = 85,      keep.inbag = TRUE) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Type:                             Regression </span>
<span class="co">#&gt; Number of trees:                  85 </span>
<span class="co">#&gt; Sample size:                      155 </span>
<span class="co">#&gt; Number of independent variables:  20 </span>
<span class="co">#&gt; Mtry:                             4 </span>
<span class="co">#&gt; Target node size:                 5 </span>
<span class="co">#&gt; Variable importance mode:         impurity </span>
<span class="co">#&gt; Splitrule:                        variance </span>
<span class="co">#&gt; OOB prediction error (MSE):       65997.22 </span>
<span class="co">#&gt; R squared (OOB):                  0.5101999</span></code></pre></div>
<p>To produce predictions we can run:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">rf_RFSI</span>, <span class="va">meuse.gridF</span><span class="op">@</span><span class="va">data</span><span class="op">)</span>
<span class="va">meuse.grid</span><span class="op">$</span><span class="va">zinc.rfsi</span> <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">predictions</span>
<span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>oma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">meuse.grid</span><span class="op">[</span><span class="st">"zinc.rfsi"</span><span class="op">]</span><span class="op">)</span>, col<span class="op">=</span><span class="va">R_pal</span><span class="op">[[</span><span class="st">"rainbow_75"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span>,
     main<span class="op">=</span><span class="st">"Predictions RFSI"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">meuse</span>, pch<span class="op">=</span><span class="st">"+"</span>, cex<span class="op">=</span><span class="fl">.8</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span>
<span class="co">#dev.off()</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-r"></span>
<img src="spatial-interpolation_files/figure-html/map-r-1.png" alt="Values of first neighbor for meuse dataset." width="100%"><p class="caption">
Figure 2.3: Values of first neighbor for meuse dataset.
</p>
</div>
<p>In summary, based on the Figs. <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-buff">2.1</a> and <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-r">2.3</a>,
we can conclude that predictions produced using nearest neighbors (Fig. <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-r">2.3</a>) show quite different patterns than
predictions based on buffer distances (Fig. <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-buff">2.1</a>). The method by <span class="citation"><a href="references.html#ref-sekulic2020random" role="doc-biblioref">Sekulić, Kilibarda, Heuvelink, Nikolić, &amp; Bajat</a> (<a href="references.html#ref-sekulic2020random" role="doc-biblioref">2020</a>)</span>
(<strong>Random Forest Spatial Interpolation</strong>) RFSI is probably more interesting for general applications as it could be
also added to spatiotemporal data problems. It also reflects closely idea of using
spatial autocorrelation of values as used in kriging since both values of neighbors and
distances to neighbors are used as covariates. On the other hand, RFSI seem to
produce predictions that contain also short range variability (more noisy) and as
such predictions might appear to look more like geostatistical simulations.</p>
</div>
<div id="interpolation-of-numeric-values-using-spatial-regression" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Interpolation of numeric values using spatial regression<a class="anchor" aria-label="anchor" href="#interpolation-of-numeric-values-using-spatial-regression"><i class="fas fa-link"></i></a>
</h2>
<p>We load the packages that will be used in this tutorial:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/envirometrix/landmap/">landmap</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://rgdal.r-forge.r-project.org">rgdal</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.leg.ufpr.br/geoR">geoR</a></span><span class="op">)</span>
<span class="co">#&gt; --------------------------------------------------------------</span>
<span class="co">#&gt;  Analysis of Geostatistical Data</span>
<span class="co">#&gt;  For an Introduction to geoR go to http://www.leg.ufpr.br/geoR</span>
<span class="co">#&gt;  geoR version 1.8-1 (built on 2020-02-08) is now loaded</span>
<span class="co">#&gt; --------------------------------------------------------------</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu">glmnet</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">kernlab</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'kernlab'</span>
<span class="co">#&gt; The following objects are masked from 'package:raster':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     buffer, rotated</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">deepnet</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">forestError</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr.mlr-org.com">mlr</a></span><span class="op">)</span></code></pre></div>
<p>For testing we use meuse data set. We can fit a 2D model to interpolate zinc
concentration based on sampling points, distance to the river and flooding frequency
maps by using:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/demo.html">demo</a></span><span class="op">(</span><span class="va">meuse</span>, echo<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/train.spLearner-methods.html">train.spLearner</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="st">"zinc"</span><span class="op">]</span>, covariates<span class="op">=</span><span class="va">meuse.grid</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dist"</span>,<span class="st">"ffreq"</span><span class="op">)</span><span class="op">]</span>, 
                     lambda <span class="op">=</span> <span class="fl">1</span>, parallel<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 51302358.935975 </span>
<span class="co">#&gt; final  value 19491244.345324 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 45220763.375836 </span>
<span class="co">#&gt; final  value 16169762.129496 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 50723533.722266 </span>
<span class="co">#&gt; final  value 18557431.400000 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 52179393.837805 </span>
<span class="co">#&gt; final  value 19673925.525180 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 48966129.905012 </span>
<span class="co">#&gt; final  value 19237393.850000 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 50327217.343373 </span>
<span class="co">#&gt; final  value 19238858.992857 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 50106999.812372 </span>
<span class="co">#&gt; final  value 19072846.949640 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 48513819.381025 </span>
<span class="co">#&gt; final  value 18339886.345324 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 48861791.596477 </span>
<span class="co">#&gt; final  value 18454493.171429 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 48476787.002316 </span>
<span class="co">#&gt; final  value 18430903.600000 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 54933965.304156 </span>
<span class="co">#&gt; final  value 20750447.509677 </span>
<span class="co">#&gt; converged</span></code></pre></div>
<p>This runs number of steps including derivation of geographical distances <span class="citation">(<a href="references.html#ref-moller2020oblique" role="doc-biblioref">Møller, Beucher, Pouladi, &amp; Greve, 2020</a>)</span>,
derivation of principal components (to make sure all features are numeric and complete),
fitting of variogram using the <strong>geoR</strong> package <span class="citation">(<a href="references.html#ref-Diggle2007Springer" role="doc-biblioref">Diggle &amp; Ribeiro Jr, 2007</a>)</span>, spatial overlay,
training of individual learners and training of the super learner. In principle, the only
parameter we need to set manually in the <code>train.spLearner</code> is the <code>lambda = 1</code>
which is required to estimate variogram: in this case the target variable is
log-normally distributed, and hence the geoR package needs the transformation
parameter set at <code>lambda = 1</code>.</p>
<p>Note that the default meta-learner in <code>train.spLearner</code> is a linear model from
five independently fitted learners <code>c("regr.ranger", "regr.xgboost", "regr.ksvm", "regr.nnet", "regr.cvglmnet")</code>. We can check the success of training based on the 5-fold
spatial Cross-Validation using:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -470.94  -97.78  -15.73   64.59 1049.38 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)   2146.8982   968.9798   2.216 0.028234 *  </span>
<span class="co">#&gt; regr.ranger      0.6822     0.1912   3.569 0.000483 ***</span>
<span class="co">#&gt; regr.xgboost     0.5249     0.4071   1.289 0.199244    </span>
<span class="co">#&gt; regr.nnet       -4.5017     2.0482  -2.198 0.029499 *  </span>
<span class="co">#&gt; regr.ksvm        0.4241     0.2148   1.975 0.050145 .  </span>
<span class="co">#&gt; regr.cvglmnet   -0.2757     0.1648  -1.673 0.096441 .  </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 199.9 on 149 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.7132, Adjusted R-squared:  0.7036 </span>
<span class="co">#&gt; F-statistic:  74.1 on 5 and 149 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>Which shows that the model explains about 65% of variability in target variable
and that <code>regr.ranger</code> learner <span class="citation">(<a href="references.html#ref-wright2017ranger" role="doc-biblioref">Wright &amp; Ziegler, 2017</a>)</span> is the strongest learner. Average
mapping error RMSE = 213, hence the models is somewhat more accurate than if we
only used buffer distances.</p>
<p>To predict values at all grids we use:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meuse.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>
<span class="co">#&gt; Predicting values using 'getStackedBaseLearnerPredictions'...TRUE</span>
<span class="co">#&gt; Deriving model errors using forestError package...TRUE</span></code></pre></div>
<p>Note that, by default, we will predict two outputs:</p>
<ul>
<li>Mean prediction: i.e. the best unbiased prediction of response;<br>
</li>
<li>Prediction errors: usually predicted as lower and upper 67% quantiles (1 std.) based on the <a href="https://cran.r-project.org/package=forestError">forestError</a> <span class="citation">(<a href="references.html#ref-lu2021unified" role="doc-biblioref">Lu &amp; Hardin, 2021</a>)</span>;</li>
</ul>
<p>If not otherwise specified, derivation of the prediction error (<strong>Root Mean Square
Prediction Error</strong>), bias and lower and upper prediction intervals is implemented
by default via the <a href="https://cran.r-project.org/package=forestError">forestError</a>
algorithm. The method is explained in detail in <span class="citation"><a href="references.html#ref-lu2021unified" role="doc-biblioref">Lu &amp; Hardin</a> (<a href="references.html#ref-lu2021unified" role="doc-biblioref">2021</a>)</span>.</p>
<p>We could also produce the prediction intervals by using the <strong>quantreg</strong> Random Forest
algorithm <span class="citation">(<a href="references.html#ref-meinshausen2006quantile" role="doc-biblioref">Meinshausen, 2006</a>)</span> as implemented in the ranger package, or as
a standard deviation of the bootstraped models, although using the method by <span class="citation"><a href="references.html#ref-lu2021unified" role="doc-biblioref">Lu &amp; Hardin</a> (<a href="references.html#ref-lu2021unified" role="doc-biblioref">2021</a>)</span> is recommended.</p>
<p>To determine the prediction errors without drastically increasing computing time,
we basically fit an independent random forest model using the five base-learners
with setting <code>quantreg = TRUE</code>:</p>
<pre><code>zinc ~ regr.ranger + regr.xgboost + regr.nnet + regr.ksvm + regr.cvglmnet</code></pre>
<p>The prediction error methods are non-parameteric and users can choose any
probability in the output via the <code>quantiles</code> argument. For example, the default
<code>quantiles</code> are set to produce prediction intervals for the .682 range, which
is the 1-standard-deviation range in the case of a Gaussian distribution.
Deriving prediction errors, however, can be come computational for large number
of features and trees in the random forest, so have in mind that EML comes with
exponentially increased computing time.</p>
<p>We can plot the predictions and prediction errors next to each other by using:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, oma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">4</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"response"</span><span class="op">]</span><span class="op">)</span>, col<span class="op">=</span><span class="va">R_pal</span><span class="op">[[</span><span class="st">"rainbow_75"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span>,
     main<span class="op">=</span><span class="st">"Predictions spLearner"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">meuse</span>, pch<span class="op">=</span><span class="st">"+"</span>, cex<span class="op">=</span><span class="fl">.8</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"model.error"</span><span class="op">]</span><span class="op">)</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/bpy.colors.html">bpy.colors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,
     main<span class="op">=</span><span class="st">"Prediction errors"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">meuse</span>, pch<span class="op">=</span><span class="st">"+"</span>, cex<span class="op">=</span><span class="fl">.8</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-zinc"></span>
<img src="spatial-interpolation_files/figure-html/map-zinc-1.png" alt="Predicted zinc content based on meuse data set." width="100%"><p class="caption">
Figure 2.4: Predicted zinc content based on meuse data set.
</p>
</div>
<p>This shows that the prediction errors (right plot) are the highest:</p>
<ul>
<li>where the model is getting further away from the training points (spatial extrapolation),<br>
</li>
<li>where individual points with high values can not be explained by covariates,<br>
</li>
<li>where measured values of the response variable are in general high,</li>
</ul>
<p>We can also plot the lower and upper prediction intervals for the .682
probability range using:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"sp.points"</span>, <span class="va">meuse</span>, pch <span class="op">=</span> <span class="st">"+"</span>, col<span class="op">=</span><span class="st">"black"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"q.lwr"</span>,<span class="st">"q.upr"</span><span class="op">)</span><span class="op">]</span>, col.regions<span class="op">=</span><span class="va">R_pal</span><span class="op">[[</span><span class="st">"rainbow_75"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span>,
       sp.layout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span>,
       main<span class="op">=</span><span class="st">"Prediction intervals (alpha = 0.318)"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-zinc-interval"></span>
<img src="spatial-interpolation_files/figure-html/map-zinc-interval-1.png" alt="Lower (q.lwr) and upper (q.upr) prediction intervals for zinc content based on meuse data set." width="100%"><p class="caption">
Figure 2.5: Lower (q.lwr) and upper (q.upr) prediction intervals for zinc content based on meuse data set.
</p>
</div>
</div>
<div id="model-fine-tuning-and-feature-selection" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Model fine-tuning and feature selection<a class="anchor" aria-label="anchor" href="#model-fine-tuning-and-feature-selection"><i class="fas fa-link"></i></a>
</h2>
<p>The function <code>tune.spLearner</code> can be used to further optimize spLearner object by:</p>
<ul>
<li>fine-tuning model parameters, especially the ranger <code>mtry</code> and XGBoost parameters,<br>
</li>
<li>reduce number of features by running feature selection via the <code><a href="https://mlr.mlr-org.com/reference/makeFeatSelWrapper.html">mlr::makeFeatSelWrapper</a></code> function,</li>
</ul>
<p>The package landmap currently requires that two base learners used include <code>regr.ranger</code> and
<code>regr.xgboost</code>, and that there are at least 3 base learners in total. The model from above can be optimized using:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/tune.spLearner-methods.html">tune.spLearner</a></span><span class="op">(</span><span class="va">m</span>, xg.skip<span class="op">=</span><span class="cn">TRUE</span>, parallel<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>which reports RMSE for different <code>mtry</code> and reports which features have been left and which removed. Note that we turn off the fine-tuning of XGboost using <code>xg.skip = TRUE</code> as it takes at the order of magnitude more time. In summary, in this specific case, the fine-tuned model is not much more accurate, but it comes with the less features:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">m0</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">)</span></code></pre></div>
<pre><code>chr [1:11] "PC2" "PC3" "PC4" "rX_0" "rY_0" "rY_0.2" "rX_0.5" "rY_1" "rY_1.4" "rY_2.9" "rY_3.1"</code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m0</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span></code></pre></div>
<pre><code>Residuals:
    Min      1Q  Median      3Q     Max 
-404.09 -139.03  -42.05   64.69 1336.47 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)   2091.87119  661.70995   3.161  0.00190 **
regr.ranger      0.14278    0.24177   0.591  0.55570   
regr.xgboost     0.92283    0.53131   1.737  0.08448 . 
regr.nnet       -4.34961    1.38703  -3.136  0.00206 **
regr.ksvm        0.66590    0.25027   2.661  0.00865 **
regr.cvglmnet   -0.08703    0.13808  -0.630  0.52944   
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 245.2 on 149 degrees of freedom
Multiple R-squared:  0.5683,    Adjusted R-squared:  0.5538 
F-statistic: 39.23 on 5 and 149 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Note that fine-tuning and feature selection can be quite computational and it is
highly recommended to start with smaller subsets of data and then measure processing
time. Note that the function <code><a href="https://mlr.mlr-org.com/reference/makeFeatSelWrapper.html">mlr::makeFeatSelWrapper</a></code> can result in errors if
the covariates have a low variance or follow a zero-inflated distribution.
Reducing the number of features via feature selection and fine-tuning of the Random
Forest <code>mtry</code> and XGboost parameters, however, can result in significantly higher
prediction speed and can also help improve accuracy.</p>
</div>
<div id="estimation-of-prediction-intervals" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Estimation of prediction intervals<a class="anchor" aria-label="anchor" href="#estimation-of-prediction-intervals"><i class="fas fa-link"></i></a>
</h2>
<p>We can also print the lower and upper <a href="http://www.sthda.com/english/articles/40-regression-analysis/166-predict-in-r-model-predictions-and-confidence-intervals/">prediction interval</a> for every location using e.g.:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>
<span class="co">#&gt;   response model.error model.bias    q.lwr    q.upr</span>
<span class="co">#&gt; 1 999.8759    214.1839   27.39722 749.5775 1289.188</span></code></pre></div>
<p>where <code>q.lwr</code> is the lower and <code>q.upr</code> is the 68% probability upper quantile value. This shows that the 68% probability interval for the location <code>x=181072, y=333611</code> is about 734–1241 which means that the prediction error (±1 s.d.), at that location, is about 250. Compare with the actual value sampled at that location:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meuse</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="fl">1</span>,<span class="st">"zinc"</span><span class="op">]</span>
<span class="co">#&gt; [1] 1022</span></code></pre></div>
<p>The average prediction error for the whole area is:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">model.error</span><span class="op">)</span>
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;   44.63   77.04  167.69  159.58  215.06  480.11</span></code></pre></div>
<p>which is somewhat lower than the RMSE derived by cross-validation, but this is
also because most of the predicted values are in fact low (skewed distribution),
and EML seems not have many problems predicting low values.</p>
<p>Note also, from the example above, if we refit a model using exactly the same
settings we might get somewhat different maps and different values. This is to
be expected as the number of training points and covariates is low, the stacking
is done by using (random) 5-fold Cross-validation, and hence results will always
be slightly different. The resulting models and maps, however, should not be
significantly different as this would indicate that the Ensemble ML is <em>unstable</em>.
In the case of larger datasets (≫1000 points), differences between predictions
should become less and less visible.</p>
</div>
<div id="predictions-using-log-transformed-target-variable" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Predictions using log-transformed target variable<a class="anchor" aria-label="anchor" href="#predictions-using-log-transformed-target-variable"><i class="fas fa-link"></i></a>
</h2>
<p>If the purpose of spatial prediction to make a more accurate predictions of low(er)
values of the response, then we can train a model with the transformed variable:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meuse</span><span class="op">$</span><span class="va">log.zinc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">$</span><span class="va">zinc</span><span class="op">)</span>
<span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/train.spLearner-methods.html">train.spLearner</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="st">"log.zinc"</span><span class="op">]</span>, covariates<span class="op">=</span><span class="va">meuse.grid</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dist"</span>,<span class="st">"ffreq"</span><span class="op">)</span><span class="op">]</span>, parallel<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 4998.882579 </span>
<span class="co">#&gt; final  value 73.222851 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 5683.969732 </span>
<span class="co">#&gt; final  value 68.561330 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 4834.044628 </span>
<span class="co">#&gt; final  value 68.897172 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 5706.570659 </span>
<span class="co">#&gt; final  value 72.649748 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 2349.857144 </span>
<span class="co">#&gt; final  value 73.103072 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 6184.275769 </span>
<span class="co">#&gt; final  value 74.169414 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 4451.463365 </span>
<span class="co">#&gt; final  value 69.440176 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 4852.414287 </span>
<span class="co">#&gt; final  value 72.774801 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 5902.359343 </span>
<span class="co">#&gt; final  value 72.079999 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 6689.386512 </span>
<span class="co">#&gt; final  value 72.803948 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  103</span>
<span class="co">#&gt; initial  value 5607.506170 </span>
<span class="co">#&gt; final  value 79.790191 </span>
<span class="co">#&gt; converged</span></code></pre></div>
<p>The summary model will usually have a somewhat higher R-square, but the best learners should stay about the same:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m2</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;      Min       1Q   Median       3Q      Max </span>
<span class="co">#&gt; -1.00361 -0.18873 -0.05022  0.14092  1.41474 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;               Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)   25.75549   10.10511   2.549 0.011822 *  </span>
<span class="co">#&gt; regr.ranger    0.74984    0.19969   3.755 0.000248 ***</span>
<span class="co">#&gt; regr.xgboost   0.31617    0.33255   0.951 0.343264    </span>
<span class="co">#&gt; regr.nnet     -4.44329    1.70769  -2.602 0.010206 *  </span>
<span class="co">#&gt; regr.ksvm      0.28476    0.19541   1.457 0.147146    </span>
<span class="co">#&gt; regr.cvglmnet -0.07384    0.15905  -0.464 0.643137    </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.3574 on 149 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.7615, Adjusted R-squared:  0.7535 </span>
<span class="co">#&gt; F-statistic: 95.14 on 5 and 149 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>We can next predict and then back-transform the values:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meuse.y2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span>
<span class="co">#&gt; Predicting values using 'getStackedBaseLearnerPredictions'...TRUE</span>
<span class="co">#&gt; Deriving model errors using forestError package...TRUE</span>
<span class="co">## back-transform:</span>
<span class="va">meuse.y2</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">response.t</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span><span class="va">meuse.y2</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">response</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-zinc2"></span>
<img src="spatial-interpolation_files/figure-html/map-zinc2-1.png" alt="Predicted zinc content based on meuse data set after log-transformation." width="100%"><p class="caption">
Figure 2.6: Predicted zinc content based on meuse data set after log-transformation.
</p>
</div>
<p>The predictions (Figs. <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-zinc">2.4</a> and <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-zinc2">2.6</a>) show similar
patterns but the prediction error maps are quite different in this case. Nevertheless,
the problem areas seem to match in both maps (see Figs. <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-zinc">2.4</a> and <a href="spatial-interpolation-using-ensemble-ml.html#fig:map-zinc2">2.6</a> right part).
If we compare distributions of two predictions we can also see that the predictions do not differ much:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggridges">ggridges</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sjmgarnier/viridis">viridis</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: viridisLite</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Attaching package: 'ggplot2'</span>
<span class="co">#&gt; The following object is masked from 'package:kernlab':</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;     alpha</span>
<span class="va">zinc.df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>zinc<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">meuse</span>, <span class="va">meuse.y</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"response"</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, 
                            <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">meuse</span>, <span class="va">meuse.y2</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"response.t"</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,
                            <span class="va">meuse</span><span class="op">$</span><span class="va">zinc</span>
<span class="op">)</span><span class="op">)</span>
<span class="va">zinc.df</span><span class="op">$</span><span class="va">type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"predicted"</span>, <span class="st">"log.predicted"</span>, <span class="st">"observed"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">i</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">zinc.df</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">zinc</span>, y <span class="op">=</span> <span class="va">type</span>, fill <span class="op">=</span> <span class="va">..x..</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://wilkelab.org/ggridges/reference/geom_ridgeline_gradient.html">geom_density_ridges_gradient</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">0.95</span>, rel_min_height <span class="op">=</span> <span class="fl">0.01</span>, gradient_lwd <span class="op">=</span> <span class="fl">1.</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## scale_x_continuous(trans='log2') +</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/scale_discrete.html">scale_y_discrete</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/viridis/man/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Zinc"</span>, option <span class="op">=</span> <span class="st">"C"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distributions comparison"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://wilkelab.org/ggridges/reference/theme_ridges.html">theme_ridges</a></span><span class="op">(</span>font_size <span class="op">=</span> <span class="fl">13</span>, grid <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Picking joint bandwidth of 110</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:hist-zinc2"></span>
<img src="spatial-interpolation_files/figure-html/hist-zinc2-1.png" alt="Difference in distributions observed and predicted." width="90%"><p class="caption">
Figure 2.7: Difference in distributions observed and predicted.
</p>
</div>
<p>The observed very high values are somewhat smoothed out but the median value is
about the same, hence we can conclude that the two EML models predict the target
variable without a bias. To estimate the prediction intervals using the log-transformed
variable we can use:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu">sp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">meuse</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>, <span class="va">meuse.y2</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">q.lwr</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">q.upr</span><span class="op">)</span>
<span class="co">#&gt; [1] 837.8133</span>
<span class="co">#&gt; [1] 1638.359</span></code></pre></div>
<p>Note that the log-transformation is not needed for a non-linear learner such
ranger and/or Xgboost, but it is often a good idea if the focus of prediction is
to get a better accuracy for lower values <span class="citation">(<a href="references.html#ref-hengl2021african" role="doc-biblioref">Tomislav Hengl et al., 2021</a>)</span>. For example, if the objective of spatial
interpolation is to map soil nutrient deficiencies, then log-transformation is a
good idea as it will produce slightly better accuracy for lower values.</p>
<p>Another advantage of using log-transformation for log-normal variables is that
the prediction intervals would most likely be symmetric, so that derivation of
prediction error (±1 s.d.) can be derived by:</p>
<pre><code>pe = (q.upr - q.lwr)/2</code></pre>
</div>
<div id="spatial-prediction-of-soil-types-factor-variable" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Spatial prediction of soil types (factor-variable)<a class="anchor" aria-label="anchor" href="#spatial-prediction-of-soil-types-factor-variable"><i class="fas fa-link"></i></a>
</h2>
<p>Ensemble Machine Learning can also be used to interpolate factor type variables
e.g. soil types. This is an example with the Ebergotzen dataset available from
the package plotKML <span class="citation">(<a href="references.html#ref-hengl2015plotkml" role="doc-biblioref">T. Hengl, Roudier, Beaudette, &amp; Pebesma, 2015</a>)</span>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Envirometrix/plotKML">plotKML</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">eberg_grid</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/sp/man/gridded-methods.html">gridded</a></span><span class="op">(</span><span class="va">eberg_grid</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">x</span><span class="op">+</span><span class="va">y</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">eberg_grid</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:31467"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">eberg</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">eberg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">X</span><span class="op">+</span><span class="va">Y</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">eberg</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:31467"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">eberg</span><span class="op">$</span><span class="va">TAXGRSC</span><span class="op">)</span>
<span class="co">#&gt;     Auenboden     Braunerde          Gley         HMoor    Kolluvisol </span>
<span class="co">#&gt;            71           790            86             1           186 </span>
<span class="co">#&gt;          Moor Parabraunerde  Pararendzina       Pelosol    Pseudogley </span>
<span class="co">#&gt;             1           704           215           252           487 </span>
<span class="co">#&gt;        Ranker       Regosol      Rendzina          NA's </span>
<span class="co">#&gt;            20           376            23           458</span></code></pre></div>
<p>In this case the target variable is <code>TAXGRSC</code> soil types based on the German soil
classification system. This changes the modeling problem from regression to
classification. We recommend using the following learners here:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sl.c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"classif.ranger"</span>, <span class="st">"classif.xgboost"</span>, <span class="st">"classif.nnTrain"</span><span class="op">)</span></code></pre></div>
<p>The model training and prediction however looks the same as for the regression:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">eberg_grid</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PRMGEO6"</span>,<span class="st">"DEMSRT6"</span>,<span class="st">"TWISRT6"</span>,<span class="st">"TIRAST6"</span><span class="op">)</span><span class="op">]</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"mF"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">mF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/train.spLearner-methods.html">train.spLearner</a></span><span class="op">(</span><span class="va">eberg</span><span class="op">[</span><span class="st">"TAXGRSC"</span><span class="op">]</span>, covariates<span class="op">=</span><span class="va">X</span>, parallel<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Converting PRMGEO6 to indicators...</span>
<span class="co">#&gt; Converting covariates to principal components...</span>
<span class="co">#&gt; Deriving oblique coordinates...TRUE</span>
<span class="co">#&gt; Subsetting observations to 79% complete cases...TRUE</span>
<span class="co">#&gt; Skipping variogram modeling...TRUE</span>
<span class="co">#&gt; Estimating block size ID for spatial Cross Validation...TRUE</span>
<span class="co">#&gt; Using learners: classif.ranger, classif.xgboost, classif.nnTrain...TRUE</span>
<span class="co">#&gt; Fitting a spatial learner using 'mlr::makeClassifTask'...TRUE</span></code></pre></div>
<p>To generate predictions we use:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"TAXGRSC"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">TAXGRSC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">mF</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Predicting values using 'getStackedBaseLearnerPredictions'...TRUE</span>
<span class="co">#&gt; Deriving model errors using sd of sign. learners...TRUE</span></code></pre></div>
</div>
<div id="classification-accuracy" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Classification accuracy<a class="anchor" aria-label="anchor" href="#classification-accuracy"><i class="fas fa-link"></i></a>
</h2>
<p>By default landmap package will predict both hard classes and probabilities per class. We can check the average accuracy of classification by using:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">newdata</span> <span class="op">=</span> <span class="va">mF</span><span class="op">@</span><span class="va">vgmModel</span><span class="op">$</span><span class="va">observations</span><span class="op">@</span><span class="va">data</span>
<span class="va">sel.e</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">newdata</span><span class="op">[</span>,<span class="va">mF</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">]</span><span class="op">)</span>
<span class="va">newdata</span> <span class="op">=</span> <span class="va">newdata</span><span class="op">[</span><span class="va">sel.e</span>, <span class="va">mF</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">]</span>
<span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">mF</span><span class="op">@</span><span class="va">spModel</span>, newdata<span class="op">=</span><span class="va">newdata</span><span class="op">)</span>
<span class="va">pred</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">truth</span> <span class="op">=</span> <span class="va">mF</span><span class="op">@</span><span class="va">vgmModel</span><span class="op">$</span><span class="va">observations</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">sel.e</span>, <span class="st">"TAXGRSC"</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/calculateConfusionMatrix.html">calculateConfusionMatrix</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                predicted</span>
<span class="co">#&gt; true            Auenboden Braunerde Gley Kolluvisol Parabraunerde Pararendzina</span>
<span class="co">#&gt;   Auenboden            34         6    0          0             5            0</span>
<span class="co">#&gt;   Braunerde             0       623    0          1            17            7</span>
<span class="co">#&gt;   Gley                  4         9   38          3             9            0</span>
<span class="co">#&gt;   Kolluvisol            0        13    1         99            17            1</span>
<span class="co">#&gt;   Parabraunerde         0        34    0          3           460            0</span>
<span class="co">#&gt;   Pararendzina          0        19    0          0             3          147</span>
<span class="co">#&gt;   Pelosol               0        11    0          1             1            2</span>
<span class="co">#&gt;   Pseudogley            0        54    2          4            24            3</span>
<span class="co">#&gt;   Ranker                0        10    0          0             6            0</span>
<span class="co">#&gt;   Regosol               0        66    0          0            10            1</span>
<span class="co">#&gt;   Rendzina              0         2    0          0             0            0</span>
<span class="co">#&gt;   -err.-                4       224    3         12            92           14</span>
<span class="co">#&gt;                predicted</span>
<span class="co">#&gt; true            Pelosol Pseudogley Ranker Regosol Rendzina -err.-</span>
<span class="co">#&gt;   Auenboden           0          3      0       0        0     14</span>
<span class="co">#&gt;   Braunerde           9          5      0       6        1     46</span>
<span class="co">#&gt;   Gley                0          5      0       0        0     30</span>
<span class="co">#&gt;   Kolluvisol          1          3      0       3        0     39</span>
<span class="co">#&gt;   Parabraunerde       2         10      0       4        0     53</span>
<span class="co">#&gt;   Pararendzina        6          1      0       0        0     29</span>
<span class="co">#&gt;   Pelosol           157          4      0       1        0     20</span>
<span class="co">#&gt;   Pseudogley          4        307      0      13        0    104</span>
<span class="co">#&gt;   Ranker              1          0      0       0        0     17</span>
<span class="co">#&gt;   Regosol             4         12      0     220        0     93</span>
<span class="co">#&gt;   Rendzina            0          0      0       0       20      2</span>
<span class="co">#&gt;   -err.-             27         43      0      27        1    447</span></code></pre></div>
<p>which shows that about 25% of classes are miss-classified and the classification
confusion is especially high for the <code>Braunerde</code> class. Note the result above is
based only on the internal training. Normally one should repeat the process
several times using 5-fold or similar (i.e. fit EML, predict errors using resampled
values only, then repeat).</p>
<p>Predicted probabilities, however, are more interesting because they also show
where EML possibly has problems and which are the transition zones between multiple classes:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">TAXGRSC</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"prob."</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">TAXGRSC</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
     col<span class="op">=</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="st">"SG_COLORS_YELLOW_RED"</span><span class="op">]</span><span class="op">]</span>, zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-tax"></span>
<img src="spatial-interpolation_files/figure-html/map-tax-1.png" alt="Predicted soil types based on EML." width="100%"><p class="caption">
Figure 2.8: Predicted soil types based on EML.
</p>
</div>
<p>The maps show that also in this case geographical distances play a role, but
overall, the features (DTM derivatives and parnt material) seem to be most important.</p>
<p>In addition to map of probabilities per class, we have also derived errors per
probability, which in this case can be computed as the standard deviation between
probabilities produced by individual learners (note: for classification problems
techniques such as quantreg random forest currently do not exist):</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">TAXGRSC</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span><span class="op">(</span><span class="st">"error."</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">TAXGRSC</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,
     col<span class="op">=</span><span class="va">SAGA_pal</span><span class="op">[[</span><span class="st">"SG_COLORS_YELLOW_BLUE"</span><span class="op">]</span><span class="op">]</span>, zlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.45</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-tax-error"></span>
<img src="spatial-interpolation_files/figure-html/map-tax-error-1.png" alt="Predicted errors per soil types based on s.d. between individual learners." width="100%"><p class="caption">
Figure 2.9: Predicted errors per soil types based on s.d. between individual learners.
</p>
</div>
<p>In probability space, instead of using RMSE or similar measures, it is often
recommended to use the measures such as the <a href="https://www.rdocumentation.org/packages/MLmetrics/versions/1.1.1/topics/LogLoss">log-loss</a> which
correctly quantifies the difference between the observed and predicted probability.
As a rule of thumb, log-loss values above 0.35 indicate poor accuracy of predictions,
but the threshold number for critically low log-loss also depends on the number
of classes. In the plot above we can note that, in general, the average error in
maps is relatively low e.g. about 0.07:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">TAXGRSC</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">error.Parabraunerde</span><span class="op">)</span>
<span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span>
<span class="co">#&gt; 0.001558 0.029074 0.041220 0.066121 0.064179 0.339019</span></code></pre></div>
<p>but there are still many pixels where confusion between classes and prediction
errors are high. Recommended strategy to improve this map is to generate <a href="https://opengeohub.github.io/spatial-sampling-ml/">a sampling
plan using the average prediction error</a> and/or Confusion Index map, then collect
new observations &amp; measurements and refit the prediction models.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></div>
<div class="next"><a href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatial-interpolation-using-ensemble-ml"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="nav-link" href="#spatial-interpolation-using-ml-and-buffer-distances-to-points"><span class="header-section-number">2.1</span> Spatial interpolation using ML and buffer distances to points</a></li>
<li><a class="nav-link" href="#spatial-interpolation-using-ml-and-geographical-distances-to-neighbors"><span class="header-section-number">2.2</span> Spatial interpolation using ML and geographical distances to neighbors</a></li>
<li><a class="nav-link" href="#interpolation-of-numeric-values-using-spatial-regression"><span class="header-section-number">2.3</span> Interpolation of numeric values using spatial regression</a></li>
<li><a class="nav-link" href="#model-fine-tuning-and-feature-selection"><span class="header-section-number">2.4</span> Model fine-tuning and feature selection</a></li>
<li><a class="nav-link" href="#estimation-of-prediction-intervals"><span class="header-section-number">2.5</span> Estimation of prediction intervals</a></li>
<li><a class="nav-link" href="#predictions-using-log-transformed-target-variable"><span class="header-section-number">2.6</span> Predictions using log-transformed target variable</a></li>
<li><a class="nav-link" href="#spatial-prediction-of-soil-types-factor-variable"><span class="header-section-number">2.7</span> Spatial prediction of soil types (factor-variable)</a></li>
<li><a class="nav-link" href="#classification-accuracy"><span class="header-section-number">2.8</span> Classification accuracy</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OpenGeoHub/spatial-prediction-eml/blob/master/spatial-interpolation.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OpenGeoHub/spatial-prediction-eml/edit/master/spatial-interpolation.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spatial and spatiotemporal interpolation using Ensemble Machine Learning</strong>" was written by Tom Hengl, Leandro Parente and Carmelo Bonannella. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
