<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>3 Spatial interpolation in 3D using Ensemble ML | Spatial and spatiotemporal interpolation using Ensemble Machine Learning</title>
<meta name="author" content="Tom Hengl, Leandro Parente and Carmelo Bonannella">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.14/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BH6J2NKGP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1BH6J2NKGP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spatial and spatiotemporal interpolation using Ensemble Machine Learning</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></li>
<li><a class="" href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="active" href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-machine-learning-for-species-distribution-modeling.html"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="" href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">6</span> Multi-scale spatial prediction models</a></li>
<li><a class="" href="summary-1.html"><span class="header-section-number">7</span> Summary</a></li>
<li><a class="" href="references.html"><span class="header-section-number">8</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OpenGeoHub/spatial-prediction-eml">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="spatial-interpolation-in-3d-using-ensemble-ml" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML<a class="anchor" aria-label="anchor" href="#spatial-interpolation-in-3d-using-ensemble-ml"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<p>You are reading the work-in-progress Spatial and spatiotemporal interpolation using Ensemble Machine Learning. This chapter is currently draft version, a peer-review publication is pending. You can find the polished first edition at <a href="https://opengeohub.github.io/spatial-prediction-eml/" class="uri">https://opengeohub.github.io/spatial-prediction-eml/</a>.</p>
</div>
<div id="mapping-concentrations-of-geochemical-elements" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Mapping concentrations of geochemical elements<a class="anchor" aria-label="anchor" href="#mapping-concentrations-of-geochemical-elements"><i class="fas fa-link"></i></a>
</h2>
<p>Ensemble ML can also be used for mapping soil variables in 3D. Consider for example
the Geochemical and minerological data set for USA48 <span class="citation">(<a href="references.html#ref-smith2014geochemical" role="doc-biblioref">Smith, Woodruff, Solano, Ellefsen, &amp; Karl, 2014</a>)</span>. This is a public data set
produced and maintained by the <a href="https://mrdata.usgs.gov/ngdb/soil/">USA Geological Survey</a> and contains laboratory measurements
of chemical elements and minerals in soil at 4,857 sites (for three depths 0 to 5 cm,
A horizon and C horizon; Fig. <a href="spatial-interpolation-in-3d-using-ensemble-ml.html#fig:ds801-example">3.1</a>).</p>
<p>We have previously imported and overlaid the sampling points vs large stack of
covariate layers using e.g.:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Training data ----</span>
<span class="va">ngs.m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"./training_data/ds_801_all.csv"</span><span class="op">)</span>
<span class="va">ngs.m</span><span class="op">$</span><span class="va">olc_id</span> <span class="op">=</span> <span class="fu">olctools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/olctools/man/encode_olc.html">encode_olc</a></span><span class="op">(</span><span class="va">ngs.m</span><span class="op">$</span><span class="va">latitude</span>, <span class="va">ngs.m</span><span class="op">$</span><span class="va">longitude</span>, <span class="fl">11</span><span class="op">)</span>
<span class="co">## Spatial overlay ----</span>
<span class="va">sel.pnts</span> <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">ngs.m</span><span class="op">$</span><span class="va">olc_id</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">sel.pnts</span><span class="op">)</span>
<span class="va">ngs.m.pnts</span> <span class="op">=</span> <span class="va">ngs.m</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">sel.pnts</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"olc_id"</span>, <span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">ngs.m.pnts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="va">longitude</span> <span class="op">+</span> <span class="va">latitude</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">ngs.m.pnts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"+init=epsg:4326"</span>
<span class="va">ngs.xy</span> <span class="op">=</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/spTransform-methods.html">spTransform</a></span><span class="op">(</span><span class="va">ngs.m.pnts</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">crs</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span>
<span class="va">tif.lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">"./1km"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html">glob2rx</a></span><span class="op">(</span><span class="st">"*.tif$"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co">## 262 layers</span>
<span class="va">ov.tmp</span> <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tif.lst</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">{</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html">extract</a></span><span class="op">(</span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">tif.lst</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>, <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/vect.html">vect</a></span><span class="op">(</span><span class="va">ngs.xy</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span>, mc.cores <span class="op">=</span> <span class="fl">80</span><span class="op">)</span>
<span class="va">ov.tmp</span> <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">ov.tmp</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="va">i</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">ov.tmp</span><span class="op">)</span> <span class="op">=</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html">file_path_sans_ext</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">tif.lst</span><span class="op">)</span><span class="op">)</span>
<span class="va">ov.tmp</span><span class="op">$</span><span class="va">olc_id</span> <span class="op">=</span> <span class="va">ngs.xy</span><span class="op">$</span><span class="va">olc_id</span>
<span class="va">reg.matrix</span> <span class="op">=</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/join.html">join</a></span><span class="op">(</span><span class="va">ngs.m</span>, <span class="va">ov.tmp</span><span class="op">)</span>
<span class="fu">saveRDS.gz</span><span class="op">(</span><span class="va">reg.matrix</span>, <span class="st">"./input/ds801_geochem1km.rds"</span><span class="op">)</span></code></pre></div>
<p>We can load the regression matrix which contains all target variables and covariates:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ds801</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/ds801_geochem1km.rds"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/dimensions.html">dim</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">)</span>
<span class="co">#&gt; [1] 14275   407</span></code></pre></div>
<p>which has a total of 4818 unique locations:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">$</span><span class="va">olc_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;  chr [1:4818] "75WXFVQG+WH6" "75WXJHVG+62X" "75WXJVM9+995" "75WXRG2G+5PV" ...</span></code></pre></div>
<p>The individual records can be browsed directly via <a href="https://mrdata.usgs.gov/ngdb/soil/" class="uri">https://mrdata.usgs.gov/ngdb/soil/</a>,
for example a single record includes:</p>
<div class="figure" style="text-align: center">
<span id="fig:ds801-example"></span>
<img src="img/Fig_geochemical_USGS_record.jpg" alt="Example of a geochemical sample with observations and measurements and coordiates of site." width="100%"><p class="caption">
Figure 3.1: Example of a geochemical sample with observations and measurements and coordiates of site.
</p>
</div>
<p>Covariates prepared to help interpolation of the geochemicals include:</p>
<ul>
<li>Distance to cities <span class="citation">(<a href="references.html#ref-nelson2019suite" role="doc-biblioref">Nelson et al., 2019</a>)</span>;<br>
</li>
<li>
<a href="https://doi.org/10.5281/zenodo.1420114">MODIS LST</a> (monthly daytime and nighttime);<br>
</li>
<li>
<a href="https://lpdaac.usgs.gov/products/mod13q1v006/">MODIS EVI</a> (long-term monthly values);<br>
</li>
<li>
<a href="https://eogdata.mines.edu/products/dmsp/">Lights at night images</a>;<br>
</li>
<li>
<a href="https://climate.esa.int/en/odp/#/project/snow">Snow occurrence probability</a>;<br>
</li>
<li>Soil property and class maps for USA48 <span class="citation">(<a href="references.html#ref-ramcharan2018soil" role="doc-biblioref">Ramcharan et al., 2018</a>)</span>;<br>
</li>
<li>Terrain / hydrological indices;</li>
</ul>
<p>We can focus on predict concentration of lead (Pb). Pb seems to change
with depth and this is seems to be consistent for different land cover classes:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openair/man/scatterPlot.html">scatterPlot</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">[</span><span class="va">ds801</span><span class="op">$</span><span class="va">pb_ppm</span><span class="op">&lt;</span><span class="fl">140</span>,<span class="op">]</span>, x <span class="op">=</span> <span class="st">"hzn_depth"</span>, y <span class="op">=</span> <span class="st">"pb_ppm"</span>, method <span class="op">=</span> <span class="st">"hexbin"</span>, col <span class="op">=</span> <span class="st">"increment"</span>, log.x<span class="op">=</span><span class="cn">TRUE</span>, log.y<span class="op">=</span><span class="cn">TRUE</span>, xlab<span class="op">=</span><span class="st">"Depth"</span>, ylab<span class="op">=</span><span class="st">"Pb [ppm]"</span>, z.lim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">100</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"landcover1"</span><span class="op">)</span>
<span class="co">#&gt; Warning: removing 11 missing rows due to landcover1</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:cor-depth"></span>
<img src="spatial-3D_files/figure-html/cor-depth-1.png" alt="Distribution of Pb as a function of land cover classes." width="100%"><p class="caption">
Figure 3.2: Distribution of Pb as a function of land cover classes.
</p>
</div>
<p>Because we are aiming at producing predictions of geochemical elements for different
depths in soil, we can also use depth of the soil sample as one of the covariates.
This makes the prediction system 3D and the model can thus be used to predict at
any new 3D location (<span class="math inline">\(X, Y, d\)</span>). To fit a RF model for this data we can use:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ds801</span><span class="op">$</span><span class="va">log.pb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">$</span><span class="va">pb_ppm</span><span class="op">)</span>
<span class="va">pr.vars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/pb.pr.vars.rds"</span><span class="op">)</span>, <span class="st">"hzn_depth"</span><span class="op">)</span>
<span class="va">sel.pb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log.pb"</span>, <span class="va">pr.vars</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="va">mrf</span> <span class="op">=</span> <span class="fu">ranger</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ranger/man/ranger.html">ranger</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">ds801</span><span class="op">$</span><span class="va">log.pb</span><span class="op">[</span><span class="va">sel.pb</span><span class="op">]</span>, x<span class="op">=</span><span class="va">ds801</span><span class="op">[</span><span class="va">sel.pb</span>, <span class="va">pr.vars</span><span class="op">]</span>, 
            num.trees <span class="op">=</span> <span class="fl">85</span>, importance <span class="op">=</span> <span class="st">'impurity'</span><span class="op">)</span>
<span class="va">mrf</span>
<span class="co">#&gt; Ranger result</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;  ranger::ranger(y = ds801$log.pb[sel.pb], x = ds801[sel.pb, pr.vars],      num.trees = 85, importance = "impurity") </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Type:                             Regression </span>
<span class="co">#&gt; Number of trees:                  85 </span>
<span class="co">#&gt; Sample size:                      14264 </span>
<span class="co">#&gt; Number of independent variables:  188 </span>
<span class="co">#&gt; Mtry:                             13 </span>
<span class="co">#&gt; Target node size:                 5 </span>
<span class="co">#&gt; Variable importance mode:         impurity </span>
<span class="co">#&gt; Splitrule:                        variance </span>
<span class="co">#&gt; OOB prediction error (MSE):       0.09636483 </span>
<span class="co">#&gt; R squared (OOB):                  0.670695</span></code></pre></div>
<p>which results in R-square of about 0.67. Because many training samples have exactly
the same coordinates (same site, three depths), we assume that this model is
over-fitting i.e. that the out-of-bag accuracy is <a href="https://opengeohub.github.io/spatial-sampling-ml/">probably over-optimistic</a>.
Instead we can fit an Ensemble model where we block points within 30 by 30-km blocks:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"eml.pb"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">lrn.rf</span> <span class="op">=</span> <span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/makeLearner.html">makeLearner</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees<span class="op">=</span><span class="fl">85</span>, importance<span class="op">=</span><span class="st">"impurity"</span>,
                            num.threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="va">lrns.pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">lrn.rf</span>, <span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/makeLearner.html">makeLearner</a></span><span class="op">(</span><span class="st">"regr.xgboost"</span><span class="op">)</span>, <span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/makeLearner.html">makeLearner</a></span><span class="op">(</span><span class="st">"regr.cvglmnet"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">tsk0.pb</span> <span class="op">&lt;-</span> <span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/RegrTask.html">makeRegrTask</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ds801</span><span class="op">[</span><span class="va">sel.pb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"log.pb"</span>, <span class="va">pr.vars</span><span class="op">)</span><span class="op">]</span>, 
                               target <span class="op">=</span> <span class="st">"log.pb"</span>, blocking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/factor.html">as.factor</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">$</span><span class="va">ID</span><span class="op">[</span><span class="va">sel.pb</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="va">init.pb</span> <span class="op">&lt;-</span> <span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/makeStackedLearner.html">makeStackedLearner</a></span><span class="op">(</span><span class="va">lrns.pb</span>, method<span class="op">=</span><span class="st">"stack.cv"</span>, super.learner<span class="op">=</span><span class="st">"regr.lm"</span>, 
                                      resampling<span class="op">=</span><span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/makeResampleDesc.html">makeResampleDesc</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"CV"</span>, blocking.cv<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">parallelMap</span><span class="fu">::</span><span class="fu"><a href="https://parallelmap.mlr-org.com/reference/parallelStart.html">parallelStartSocket</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
  <span class="va">eml.pb</span> <span class="op">=</span> <span class="fu"><a href="https://mlr.mlr-org.com/reference/train.html">train</a></span><span class="op">(</span><span class="va">init.pb</span>, <span class="va">tsk0.pb</span><span class="op">)</span>
  <span class="fu">parallelMap</span><span class="fu">::</span><span class="fu"><a href="https://parallelmap.mlr-org.com/reference/parallelStop.html">parallelStop</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; [10:57:29] WARNING: amalgamation/../src/objective/regression_obj.cu:170: reg:linear is now deprecated in favor of reg:squarederror.</span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">eml.pb</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -2.3979 -0.1990 -0.0117  0.1699  6.2948 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;               Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)   -0.64745    0.04296 -15.069  &lt; 2e-16 ***</span>
<span class="co">#&gt; regr.ranger    0.85552    0.02152  39.755  &lt; 2e-16 ***</span>
<span class="co">#&gt; regr.xgboost   0.26550    0.05337   4.974 6.62e-07 ***</span>
<span class="co">#&gt; regr.cvglmnet  0.25631    0.02024  12.665  &lt; 2e-16 ***</span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 0.4075 on 14260 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.4328, Adjusted R-squared:  0.4327 </span>
<span class="co">#&gt; F-statistic:  3627 on 3 and 14260 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>which shows somewhat lower R-square of 0.44, this time that whole sites have
been taken out and hence this seems to be somewhat more realistic estimate of the
mapping accuracy <span class="citation">(<a href="references.html#ref-roberts2017cross" role="doc-biblioref">Roberts et al., 2017</a>)</span>. The accuracy plot shows that the model has
some problems with predicting higher values, but overall matches the observed values:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t.pb</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/quantile.html">quantile</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">$</span><span class="va">log.pb</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.001</span>, <span class="fl">0.01</span>, <span class="fl">0.999</span><span class="op">)</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">plot_hexbin</span><span class="op">(</span>varn<span class="op">=</span><span class="st">"log.pb"</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">t.pb</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">t.pb</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">t.pb</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, length<span class="op">=</span><span class="fl">25</span><span class="op">)</span><span class="op">)</span>, 
      meas<span class="op">=</span><span class="va">eml.pb</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">log.pb</span>, 
      pred<span class="op">=</span><span class="va">eml.pb</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">fitted.values</span>,
      main<span class="op">=</span><span class="st">"Pb [EML]"</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:ac-pb1"></span>
<img src="img/plot_CV_log.pb.png" alt="Accuracy plot for Pb concentration in soil fitted using Ensemble ML." width="90%"><p class="caption">
Figure 3.3: Accuracy plot for Pb concentration in soil fitted using Ensemble ML.
</p>
</div>
<p>Variables most important for explaining distribution of the target variable (based on the variable importance)
seem to be soil depth (<code>hnz_depth</code>), soil type maps, annual day time temperature and travel time to cities:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">xl.pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">mlr</span><span class="fu">::</span><span class="fu"><a href="https://mlr.mlr-org.com/reference/getFeatureImportance.html">getFeatureImportance</a></span><span class="op">(</span><span class="va">eml.pb</span><span class="op">[[</span><span class="st">"learner.model"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"base.models"</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">res</span><span class="op">)</span>
<span class="va">xl.pb</span><span class="op">$</span><span class="va">relative_importance</span> <span class="op">=</span> <span class="fl">100</span><span class="op">*</span><span class="va">xl.pb</span><span class="op">$</span><span class="va">importance</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">xl.pb</span><span class="op">$</span><span class="va">importance</span><span class="op">)</span>
<span class="va">xl.pb</span> <span class="op">=</span> <span class="va">xl.pb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">xl.pb</span><span class="op">$</span><span class="va">relative_importance</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">xl.pb</span><span class="op">$</span><span class="va">variable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">xl.pb</span><span class="op">)</span><span class="op">)</span>, <span class="st">". "</span>, <span class="va">xl.pb</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">xl.pb</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">relative_importance</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">relative_importance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"steelblue"</span>,
           stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Variable importance"</span>,
       x <span class="op">=</span> <span class="cn">NULL</span>,
       y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:varimp-pb"></span>
<img src="spatial-3D_files/figure-html/varimp-pb-1.png" alt="Variable importance for 3D prediction model for Pb concentrations." width="90%"><p class="caption">
Figure 3.4: Variable importance for 3D prediction model for Pb concentrations.
</p>
</div>
<p>If we plot the travel time to cities vs Pb concentrations, we can clearly see that
Pb is negatively correlated with travel time to cities (following a log-log linear relationship):</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">openair</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/openair/man/scatterPlot.html">scatterPlot</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">[</span><span class="va">ds801</span><span class="op">$</span><span class="va">pb_ppm</span><span class="op">&lt;</span><span class="fl">140</span>,<span class="op">]</span>, x <span class="op">=</span> <span class="st">"travel_time_to_cities_1_usa48"</span>, y <span class="op">=</span> <span class="st">"pb_ppm"</span>, method <span class="op">=</span> <span class="st">"hexbin"</span>, col <span class="op">=</span> <span class="st">"increment"</span>, log.x<span class="op">=</span><span class="cn">TRUE</span>, log.y<span class="op">=</span><span class="cn">TRUE</span>, xlab<span class="op">=</span><span class="st">"Travel time to cities 1"</span>, ylab<span class="op">=</span><span class="st">"Pb [ppm]"</span>, type<span class="op">=</span><span class="st">"hzn_depth"</span><span class="op">)</span>
<span class="co">#&gt; Warning: removing 11 missing rows due to hzn_depth</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:cor-cities"></span>
<img src="spatial-3D_files/figure-html/cor-cities-1.png" alt="Distribution of Pb as a function of travel time to cities for different depths." width="100%"><p class="caption">
Figure 3.5: Distribution of Pb as a function of travel time to cities for different depths.
</p>
</div>
</div>
<div id="predictions-in-3d" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Predictions in 3D<a class="anchor" aria-label="anchor" href="#predictions-in-3d"><i class="fas fa-link"></i></a>
</h2>
<p>To produce predictions we can focus on area around Chicago conglomeration. We can
load the covariate layers by using:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">g1km</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"./input/chicago_grid1km.rds"</span><span class="op">)</span></code></pre></div>
<p>This contains all layers we used for training. We can generate predictions by
adding a depth column, then write predictions to GeoTIFFs:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">out.tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"./output/pb_ppm_"</span>, <span class="va">k</span>, <span class="st">"cm_1km.tif"</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">g1km</span><span class="op">$</span><span class="va">hzn_depth</span> <span class="op">=</span> <span class="va">k</span>
    <span class="va">sel.na</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">g1km</span><span class="op">)</span>
    <span class="va">newdata</span> <span class="op">=</span> <span class="va">g1km</span><span class="op">[</span><span class="va">sel.na</span>, <span class="va">eml.pb</span><span class="op">$</span><span class="va">features</span><span class="op">]</span>
    <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">eml.pb</span>, newdata<span class="op">=</span><span class="va">newdata</span><span class="op">)</span>
    <span class="va">g1km.sp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialGridDataFrame.html">SpatialPixelsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">g1km</span><span class="op">[</span><span class="va">sel.na</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, 
                data<span class="op">=</span><span class="va">pred</span><span class="op">$</span><span class="va">data</span>, proj4string<span class="op">=</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"EPSG:5070"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">g1km.sp</span><span class="op">$</span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span><span class="va">g1km.sp</span><span class="op">$</span><span class="va">response</span><span class="op">)</span>
    <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">g1km.sp</span><span class="op">[</span><span class="st">"pred"</span><span class="op">]</span>, <span class="va">out.tif</span>, type<span class="op">=</span><span class="st">"Int16"</span>, mvFlag<span class="op">=</span><span class="op">-</span><span class="fl">32768</span>, options<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#gc()</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>This finally gives the following pattern:</p>
<div class="figure" style="text-align: center">
<span id="fig:pred-pb1"></span>
<img src="img/Pb_predictions_d1.jpg" alt="Predictions of Pb concentration for different soil depths based on Ensemble ML. Points indicate training points used to build the predictive mapping model. Red color indicates high values. Values of Pb clearly drop with soil depth." width="90%"><img src="img/Pb_predictions_d2.jpg" alt="Predictions of Pb concentration for different soil depths based on Ensemble ML. Points indicate training points used to build the predictive mapping model. Red color indicates high values. Values of Pb clearly drop with soil depth." width="90%"><img src="img/Pb_predictions_d3.jpg" alt="Predictions of Pb concentration for different soil depths based on Ensemble ML. Points indicate training points used to build the predictive mapping model. Red color indicates high values. Values of Pb clearly drop with soil depth." width="90%"><p class="caption">
Figure 3.6: Predictions of Pb concentration for different soil depths based on Ensemble ML. Points indicate training points used to build the predictive mapping model. Red color indicates high values. Values of Pb clearly drop with soil depth.
</p>
</div>
<p>Based on these results, it can be said that in general:</p>
<ol style="list-style-type: decimal">
<li>Distribution of Pb across USA seem to be controlled by a mixture of factors
including climatic factors, soil-terrain units and anthropogenic factors (travel distance to cities);<br>
</li>
<li>Overall big urban areas show significantly higher concentrations for some heavy
metals and this relationship if log-log linear;<br>
</li>
<li>Soil depth for some geochemical elements comes as the overall most important
covariate hence mapping soil variables in 3D is fully justified;</li>
</ol>
</div>
<div id="modeling-multiple-geochemicals-using-a-single-ml-model" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Modeling multiple geochemicals using a single ML model<a class="anchor" aria-label="anchor" href="#modeling-multiple-geochemicals-using-a-single-ml-model"><i class="fas fa-link"></i></a>
</h2>
<p>The package <strong>randomForestSRC</strong> <span class="citation">(<a href="references.html#ref-Ishwaran2021" role="doc-biblioref">Ishwaran &amp; Kogalur, 2022</a>)</span> provides functionality to run so-called
<a href="https://www.randomforestsrc.org/articles/getstarted.html#multivariate-outcomes">“Multivariate Outcomes”</a> which means that one can fit a model with multivariate outcomes.
In the case of geochemical data, usually multitude of geochemicals (50+) are analyzed in lab, so that
it seems more practical to fit a single model to predict p+ target variables (outcomes) all at once.</p>
<p>In the case of <code>ds801</code> dataset we can first specify number of target variables that we would like to map:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tvs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"as_ppm"</span>, <span class="st">"al_pct"</span>, <span class="st">"cd_ppm"</span>, <span class="st">"cr_ppm"</span>, <span class="st">"cu_ppm"</span>, <span class="st">"fe_pct"</span>,
        <span class="st">"mo_ppm"</span>, <span class="st">"ni_ppm"</span>, <span class="st">"se_ppm"</span>, <span class="st">"th_ppm"</span>, <span class="st">"zn_ppm"</span>, <span class="st">"pb_ppm"</span><span class="op">)</span>
<span class="co">## number of missing values per variable:</span>
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">tvs</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ds801</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; as_ppm al_pct cd_ppm cr_ppm cu_ppm fe_pct mo_ppm ni_ppm se_ppm th_ppm zn_ppm </span>
<span class="co">#&gt;    198      4   4290     41     23     24     32     43   6906     19     31 </span>
<span class="co">#&gt; pb_ppm </span>
<span class="co">#&gt;     11</span></code></pre></div>
<p>These variables are obviously highly cross-correlated and their multiliearity could be reduced:</p>
<div class="figure" style="text-align: center">
<span id="fig:corPlot"></span>
<img src="spatial-3D_files/figure-html/corPlot-1.png" alt="Correlation matrics for a selection of geochemicals. Number indicates correlation coefficient (0 to 100%). All variables seem to be positively correlated." width="100%"><p class="caption">
Figure 3.7: Correlation matrics for a selection of geochemicals. Number indicates correlation coefficient (0 to 100%). All variables seem to be positively correlated.
</p>
</div>
<p>Here especially <code>zn</code>, <code>cu</code>, <code>fe</code>, <code>al</code> and <code>ni</code> seem to be highly cross-correlated.
Converting them to Principal Components is a logical step to reduce overlap in data.
Before transferring the original values to Principal Components we can also filter out
all missing values by replacing them with a mean value (for scaled variable this is 0):</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ds801.x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ds801.x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">ds801.xd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">ds801.x</span><span class="op">)</span>
<span class="va">pcs.ds801</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ds801.xd</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:biplot"></span>
<img src="spatial-3D_files/figure-html/biplot-1.png" alt="Results of PCA in a biplot." width="90%"><p class="caption">
Figure 3.8: Results of PCA in a biplot.
</p>
</div>
<p>We also recommend converting all log-normal or percent variables using <code>log1p</code> and/or logit transformation
to: (1) produce close-to-normal distribution and (2) avoid producting predictions beyond the physical range of data
(e.g. negative values or values &gt;100%).</p>
<p>First 6 components explain majority of variance in data, but it appears that to be on a safe-side,
we can model up to PC11:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">pcs.ds801</span><span class="op">)</span>
<span class="co">#&gt; Importance of components:</span>
<span class="co">#&gt;                           PC1    PC2     PC3     PC4     PC5     PC6     PC7</span>
<span class="co">#&gt; Standard deviation     2.4221 1.1343 0.98982 0.79734 0.74930 0.67263 0.63508</span>
<span class="co">#&gt; Proportion of Variance 0.5244 0.1150 0.08759 0.05684 0.05019 0.04045 0.03606</span>
<span class="co">#&gt; Cumulative Proportion  0.5244 0.6395 0.72706 0.78390 0.83409 0.87454 0.91060</span>
<span class="co">#&gt;                            PC8     PC9    PC10    PC11    PC12</span>
<span class="co">#&gt; Standard deviation     0.58353 0.50063 0.41659 0.37258 0.31070</span>
<span class="co">#&gt; Proportion of Variance 0.03044 0.02241 0.01551 0.01241 0.00863</span>
<span class="co">#&gt; Cumulative Proportion  0.94104 0.96344 0.97896 0.99137 1.00000</span></code></pre></div>
<p>As a rule of thumb, we advise to focus on components that explain &gt;95% of variance in the data;
to be certain one can also use &gt;99% as the threshold.</p>
<p>Note the steps we have taken so far include: (1) we first transform the target variables to achieve close to normal-distribution,
(2) we scale all numbers to have 0 = mean and 1 = standard deviation, (3) we replace missing value with the
mean value (0 in this case), (4) we derive Principle Components with all data so nothing is lost.</p>
<p>Next, we can fit a model using the randomForestSRC package and all PCs expect for the last PC (which is
usually pure noise):</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nComp</span> <span class="op">=</span> <span class="fl">11</span>; <span class="va">Ntree</span> <span class="op">=</span> <span class="fl">85</span>
<span class="va">xdta</span> <span class="op">=</span> <span class="va">ds801</span><span class="op">[</span>,<span class="va">pr.vars</span><span class="op">]</span>
<span class="va">ydta</span> <span class="op">=</span> <span class="va">pcs.ds801</span><span class="op">$</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">nComp</span><span class="op">]</span>
<span class="va">tfm</span> <span class="op">=</span> <span class="fu">get.mv.formula</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">ydta</span><span class="op">)</span><span class="op">)</span>
<span class="va">m.s1</span> <span class="op">=</span> <span class="fu">randomForestSRC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/randomForestSRC/man/rfsrc.html">rfsrc</a></span><span class="op">(</span><span class="va">tfm</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">ydta</span>, <span class="va">xdta</span><span class="op">)</span>, 
                              importance<span class="op">=</span><span class="cn">TRUE</span>, ntree <span class="op">=</span> <span class="va">Ntree</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">m.s1</span>, outcome.target <span class="op">=</span> <span class="st">"PC1"</span><span class="op">)</span>
<span class="co">#&gt;                          Sample size: 14275</span>
<span class="co">#&gt;                      Number of trees: 85</span>
<span class="co">#&gt;            Forest terminal node size: 5</span>
<span class="co">#&gt;        Average no. of terminal nodes: 1885.718</span>
<span class="co">#&gt; No. of variables tried at each split: 63</span>
<span class="co">#&gt;               Total no. of variables: 188</span>
<span class="co">#&gt;               Total no. of responses: 11</span>
<span class="co">#&gt;          User has requested response: PC1</span>
<span class="co">#&gt;        Resampling used to grow trees: swor</span>
<span class="co">#&gt;     Resample size used to grow trees: 9022</span>
<span class="co">#&gt;                             Analysis: mRF-R</span>
<span class="co">#&gt;                               Family: regr+</span>
<span class="co">#&gt;                       Splitting rule: mv.mse *random*</span>
<span class="co">#&gt;        Number of random split points: 10</span>
<span class="co">#&gt;                 % variance explained: 74.26</span>
<span class="co">#&gt;                           Error rate: 1.51</span></code></pre></div>
<p>This basically fits a multivariate RF of form <code>rfsrc(Multivar(y1, y2, ..., yd) ~ . , my.data, ...)</code>.
The resulting model show that the models explain significant part of variance. As expected the significance of the model
is usually the highest for the higher level components (PC1, PC2), then it gradually drops.</p>
<p>We can access the variable importance of each individual model by using:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu">get.mv.vimp</span><span class="op">(</span><span class="va">m.s1</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="st">"PC1"</span><span class="op">]</span>
<span class="va">vmp</span><span class="op">$</span><span class="va">relative_importance</span> <span class="op">=</span> <span class="fl">100</span><span class="op">*</span><span class="va">vmp</span><span class="op">$</span><span class="va">PC1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">vmp</span><span class="op">$</span><span class="va">PC1</span><span class="op">)</span>
<span class="va">vmp</span> <span class="op">=</span> <span class="va">vmp</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">vmp</span><span class="op">$</span><span class="va">relative_importance</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">vmp</span><span class="op">$</span><span class="va">variable</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html">nrow</a></span><span class="op">(</span><span class="va">vmp</span><span class="op">)</span><span class="op">)</span>, <span class="st">". "</span>, <span class="fu"><a href="https://rdrr.io/r/base/row.names.html">row.names</a></span><span class="op">(</span><span class="va">vmp</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">vmp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">20</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">relative_importance</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">relative_importance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/geom_bar.html">geom_bar</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"steelblue"</span>,
           stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Variable importance"</span>,
       x <span class="op">=</span> <span class="cn">NULL</span>,
       y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/theme.html">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ggplot2/man/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:varimp-pc1"></span>
<img src="spatial-3D_files/figure-html/varimp-pc1-1.png" alt="Variable importance for 3D prediction model for PC1." width="90%"><p class="caption">
Figure 3.9: Variable importance for 3D prediction model for PC1.
</p>
</div>
<p>To generate predictions for different depths and for different PCs, we can run loop
the <code>predict.rfsrc</code> function:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">11</span><span class="op">)</span><span class="op">{</span>
 <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">30</span>, <span class="fl">60</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">out.tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"./output/pc"</span>, <span class="va">j</span>, <span class="st">"_"</span>, <span class="va">k</span>, <span class="st">"cm_1km.tif"</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="va">g1km</span><span class="op">$</span><span class="va">hzn_depth</span> <span class="op">=</span> <span class="va">k</span>
    <span class="va">sel.na</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">g1km</span><span class="op">)</span>
    <span class="va">newdata</span> <span class="op">=</span> <span class="va">g1km</span><span class="op">[</span><span class="va">sel.na</span>, <span class="va">pr.vars</span><span class="op">]</span>
    <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m.s1</span>, m.target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PC"</span>, <span class="va">j</span><span class="op">)</span>, newdata<span class="op">=</span><span class="va">newdata</span><span class="op">)</span>
    <span class="va">g1km.sp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/SpatialGridDataFrame.html">SpatialPixelsDataFrame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">g1km</span><span class="op">[</span><span class="va">sel.na</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, 
                data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred</span><span class="op">$</span><span class="va">regrOutput</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PC"</span>, <span class="va">j</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, 
                proj4string<span class="op">=</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"EPSG:5070"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">g1km.sp</span><span class="op">$</span><span class="va">pred</span> <span class="op">=</span> <span class="va">g1km.sp</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="fl">100</span>
    <span class="fu">rgdal</span><span class="fu">::</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">g1km.sp</span><span class="op">[</span><span class="st">"pred"</span><span class="op">]</span>, <span class="va">out.tif</span>, type<span class="op">=</span><span class="st">"Int16"</span>, mvFlag<span class="op">=</span><span class="op">-</span><span class="fl">32768</span>, options<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
    <span class="co">#gc()</span>
  <span class="op">}</span>
 <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>This gives predictions (in the scaled space) for each of the original target variables and for all depths.
Note that, because the randomForestSRC package <a href="https://www.randomforestsrc.org/articles/parallel.html">uses by default all cores</a> to run model training and prediction,
there is no need to specify any further parallelization i.e. it is fine to run processing in a loop.</p>
<p>After we generate predictions, we can (1) first <a href="https://stats.stackexchange.com/questions/229092/how-to-reverse-pca-and-reconstruct-original-variables-from-several-principal-com">back-transform values to original scale</a> using the PCA model eigenvectors, (2) scale-back from log-transformation.
For example the predictions for top-soil, we first load all predicted PC’s:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ls.5cm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="st">'./output'</span>, pattern<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/utils/glob2rx.html">glob2rx</a></span><span class="op">(</span><span class="st">"^pc*_5cm_1km.tif$"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">pred.tops</span> <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">ls.5cm</span><span class="op">)</span>
<span class="va">pred.tops</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">pred.tops</span>, <span class="st">"SpatialGridDataFrame"</span><span class="op">)</span></code></pre></div>
<p>next, we back-transform values to original scale by using:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Xhat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">pred.tops</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"pc"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">nComp</span>, <span class="st">"_5cm_1km"</span><span class="op">)</span><span class="op">]</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/transpose.html">t</a></span><span class="op">(</span><span class="va">pcs.ds801</span><span class="op">$</span><span class="va">rotation</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="va">nComp</span><span class="op">]</span><span class="op">)</span>
<span class="co">## scale-back to the original mean / stdev:</span>
<span class="va">Xhat.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html">sweep</a></span><span class="op">(</span><span class="va">Xhat</span> <span class="op"><a href="https://rdrr.io/pkg/Matrix/man/matrix-products.html">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">ds801.x</span>, <span class="st">'scaled:scale'</span><span class="op">)</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">ds801.x</span>, <span class="st">'scaled:center'</span><span class="op">)</span>, <span class="st">"+"</span><span class="op">)</span>
<span class="va">Xhat.s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">expm1</a></span><span class="op">(</span> <span class="va">Xhat.s</span> <span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">Xhat.s</span><span class="op">)</span> <span class="op">=</span> <span class="va">tvs</span></code></pre></div>
<p>We can plot two predictions of <code>Pb</code> (using EML produced in the previous example; and using PCA analysis) next to each other:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred.tops</span><span class="op">$</span><span class="va">Pb_5cm_1km.PCA</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="va">Xhat.s</span><span class="op">[</span>,<span class="st">"pb_ppm"</span><span class="op">]</span><span class="op">)</span>
<span class="va">pred.tops</span><span class="op">$</span><span class="va">Pb_5cm_1km.EML</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log1p</a></span><span class="op">(</span><span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"./output/pb_ppm_5cm_1km.tif"</span><span class="op">)</span><span class="op">$</span><span class="va">band1</span><span class="op">)</span>
<span class="co">#&gt; ./output/pb_ppm_5cm_1km.tif has GDAL driver GTiff </span>
<span class="co">#&gt; and has 342 rows and 378 columns</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/spplot.html">spplot</a></span><span class="op">(</span><span class="va">pred.tops</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Pb_5cm_1km.EML"</span>, <span class="st">"Pb_5cm_1km.PCA"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:pca-pred"></span>
<img src="spatial-3D_files/figure-html/pca-pred-1.png" alt="Predicted Pb concentration using ensemble ML (left) vs using the decomposition-composition PCA method (right)." width="100%"><p class="caption">
Figure 3.10: Predicted Pb concentration using ensemble ML (left) vs using the decomposition-composition PCA method (right).
</p>
</div>
<p>This shows that the predictions are quite similar, except the PCA-method somewhat smooths out some very
high values.</p>
<p>By combining PCA analysis and predictive mapping (we refer to this method as the <strong>Decomposition-composition PCA method</strong>)
one integrates modeling of multiple cross-correlated variables and multicolinearity reduction.
As a rule of thumb one can model only PCs that explain up to 99% of variance in data, this way modeling
effort can be significantly reduced (e.g. for 50+ target variables one could model all target variables
only a dozen of PCs). A disadvantage of the Decomposition-composition PCA method is that interpretation of
scaled values is somewhat more complex, certainly more abstract.</p>
</div>
<div id="advantages-and-limitations-of-running-3d-predictive-mapping" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Advantages and limitations of running 3D predictive mapping<a class="anchor" aria-label="anchor" href="#advantages-and-limitations-of-running-3d-predictive-mapping"><i class="fas fa-link"></i></a>
</h2>
<p>In summary 3D soil mapping is relatively straight forward to implement especially
for mapping soil variables from soil profiles (multiple samples per soil layer).
Before modeling the target variable with depth, it is a good idea to plot
relationship between target variable and depth under different settings
(as in Fig. <a href="spatial-interpolation-in-3d-using-ensemble-ml.html#fig:cor-depth">3.2</a>). 3D soil mapping based on Machine Learning is
now increasingly common <span class="citation">(<a href="references.html#ref-hengl2019predictive" role="doc-biblioref">T. Hengl &amp; MacMillan, 2019</a>; <a href="references.html#ref-sothe2022large" role="doc-biblioref">Sothe, Gonsamo, Arabian, &amp; Snider, 2022</a>)</span>.</p>
<p>A limitation for 3D predictive mapping is the size of data i.e. data volumes
increasing proportionally to number of slices we need to predict (in this case three).
Also, we show that points with exactly the same coordinates might result in e.g. 
Random Forest overfitting emphasizing some covariate layers that are possibly
less important, hence it is again important to use the blocking parameter that
separates training and validation points.</p>
<p>Soil depth is for many soil variables most important explanatory variables, but
in the cases it does not correlate with the target variable, there is probably
also no need for 3D soil mapping. In the case depth is not significantly
correlated, one could simply first aggregate all values to fixed block depth and
convert modeling from 3D to 2D.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></div>
<div class="next"><a href="spatiotemporal-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#spatial-interpolation-in-3d-using-ensemble-ml"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="nav-link" href="#mapping-concentrations-of-geochemical-elements"><span class="header-section-number">3.1</span> Mapping concentrations of geochemical elements</a></li>
<li><a class="nav-link" href="#predictions-in-3d"><span class="header-section-number">3.2</span> Predictions in 3D</a></li>
<li><a class="nav-link" href="#modeling-multiple-geochemicals-using-a-single-ml-model"><span class="header-section-number">3.3</span> Modeling multiple geochemicals using a single ML model</a></li>
<li><a class="nav-link" href="#advantages-and-limitations-of-running-3d-predictive-mapping"><span class="header-section-number">3.4</span> Advantages and limitations of running 3D predictive mapping</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OpenGeoHub/spatial-prediction-eml/blob/master/spatial-3D.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OpenGeoHub/spatial-prediction-eml/edit/master/spatial-3D.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spatial and spatiotemporal interpolation using Ensemble Machine Learning</strong>" was written by Tom Hengl, Leandro Parente and Carmelo Bonannella. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
