<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 Multi-scale spatial prediction models | Spatial and spatiotemporal interpolation using Ensemble Machine Learning</title>
<meta name="author" content="Tom Hengl, Leandro Parente, Carmelo Bonannella and contributors">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.14/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-1BH6J2NKGP"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1BH6J2NKGP');
    </script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Spatial and spatiotemporal interpolation using Ensemble Machine Learning</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="introduction-to-spatial-and-spatiotemporal-data.html"><span class="header-section-number">1</span> Introduction to spatial and spatiotemporal data</a></li>
<li><a class="" href="spatial-interpolation-using-ensemble-ml.html"><span class="header-section-number">2</span> Spatial interpolation using Ensemble ML</a></li>
<li><a class="" href="spatial-interpolation-in-3d-using-ensemble-ml.html"><span class="header-section-number">3</span> Spatial interpolation in 3D using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-ml.html"><span class="header-section-number">4</span> Spatiotemporal interpolation using Ensemble ML</a></li>
<li><a class="" href="spatiotemporal-machine-learning-for-species-distribution-modeling.html"><span class="header-section-number">5</span> Spatiotemporal Machine Learning for Species Distribution Modeling</a></li>
<li><a class="" href="spatiotemporal-prediction-of-soil-organic-carbon.html"><span class="header-section-number">6</span> Spatiotemporal prediction of Soil Organic Carbon</a></li>
<li><a class="active" href="multi-scale-spatial-prediction-models.html"><span class="header-section-number">7</span> Multi-scale spatial prediction models</a></li>
<li><a class="" href="summary-1.html"><span class="header-section-number">8</span> Summary</a></li>
<li><a class="" href="references.html"><span class="header-section-number">9</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/OpenGeoHub/spatial-prediction-eml">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="multi-scale-spatial-prediction-models" class="section level1" number="7">
<h1>
<span class="header-section-number">7</span> Multi-scale spatial prediction models<a class="anchor" aria-label="anchor" href="#multi-scale-spatial-prediction-models"><i class="fas fa-link"></i></a>
</h1>
<div class="rmdnote">
<p>You are reading the work-in-progress Spatial and spatiotemporal interpolation using Ensemble Machine Learning. This chapter is currently draft version, a peer-review publication is pending. You can find the polished first edition at <a href="https://opengeohub.github.io/spatial-prediction-eml/" class="uri">https://opengeohub.github.io/spatial-prediction-eml/</a>.</p>
</div>
<div id="rationale-for-multiscale-models" class="section level2" number="7.1">
<h2>
<span class="header-section-number">7.1</span> Rationale for multiscale models<a class="anchor" aria-label="anchor" href="#rationale-for-multiscale-models"><i class="fas fa-link"></i></a>
</h2>
<p>In the previous examples we have shown how to fit spatial and spatiotemporal models
to generate predictions using multiple covariate layers. In practice spatial layers
used for predictive mapping could come and different spatial scales i.e. they could
be represent different part of spatial variation. There are at least two scales of
spatial variation <span class="citation">(<a href="references.html#ref-hengl2021african" role="doc-biblioref">Tomislav Hengl et al., 2021</a>)</span>:</p>
<ul>
<li>
<strong>Coarse scale</strong> e.g. representing effects of planetary climate;</li>
<li>
<strong>Fine scale</strong> e.g. representing meso-relief and local conditions;</li>
</ul>
<p>In fact, we can imagine that spatial variation can probably be decomposed into different
scale components, as illustrated in plot below.</p>
<div class="figure" style="text-align: center">
<span id="fig:decomposition-signal"></span>
<img src="img/Fig_signal_decomposition.png" alt="Decomposition of a signal of spatial variation into four components plus noise. Based on McBratney (1998)." width="100%"><p class="caption">
Figure 7.1: Decomposition of a signal of spatial variation into four components plus noise. Based on McBratney (1998).
</p>
</div>
<p>The idea of modeling soil spatial variation at different scales can be traced back to the work of <span class="citation">McBratney (<a href="references.html#ref-McBratney1998" role="doc-biblioref">1998</a>)</span>.
That also suggests that we could produce predictions models of different components
of variation, then sum the components to produce ensemble prediction. The rationale
for this, in the case of large datasets, is that we can (a) significantly reduce size
of the data, (b) separate and better focus modeling based on the component of variation.</p>
</div>
<div id="fitting-and-predicting-with-multiscale-models" class="section level2" number="7.2">
<h2>
<span class="header-section-number">7.2</span> Fitting and predicting with multiscale models<a class="anchor" aria-label="anchor" href="#fitting-and-predicting-with-multiscale-models"><i class="fas fa-link"></i></a>
</h2>
<p>In the next example we use EML to make spatial predictions using data-set with
two sets of covariates basically at different resolutions 250-m and 100-m. For
this we use the Edgeroi data-set <span class="citation">(<a href="references.html#ref-malone2009mapping" role="doc-biblioref">Malone, McBratney, Minasny, &amp; Laslett, 2009</a>)</span> used commonly in the soil
science to demonstrate 3D soil mapping of soil organic carbon (g/kg) based on
samples taken from diagnostic soil horizons (multiple depth intervals):</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">edgeroi</span><span class="op">)</span>
<span class="va">edgeroi.sp</span> <span class="op">&lt;-</span> <span class="va">edgeroi</span><span class="op">$</span><span class="va">sites</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">edgeroi.sp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span> <span class="va">LONGDA94</span> <span class="op">+</span> <span class="va">LATGDA94</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">edgeroi.sp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs"</span><span class="op">)</span>
<span class="va">edgeroi.sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/spTransform.html">spTransform</a></span><span class="op">(</span><span class="va">edgeroi.sp</span>, <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:28355"</span><span class="op">)</span><span class="op">)</span>
<span class="va">out.file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html">getwd</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"output/edgeroi/edgeroi_training_points.gpkg"</span>, sep<span class="op">=</span><span class="st">"/"</span><span class="op">)</span>
<span class="co">#if(!file.exists("out.file")){</span>
<span class="co">#  writeOGR(edgeroi.sp, out.file, layer="edgeroi_training_points", driver = "GPKG")</span>
<span class="co">#}</span></code></pre></div>
<p>We can fit two independent EML’s using the two sets of covariates and then
produce final predictions by combining them. We will refer to the two models as
coarse and fine-scale models. The fine-scale models will often be much larger
datasets and require serious computing capacity.</p>
</div>
<div id="coarse-scale-model" class="section level2" number="7.3">
<h2>
<span class="header-section-number">7.3</span> Coarse-scale model<a class="anchor" aria-label="anchor" href="#coarse-scale-model"><i class="fas fa-link"></i></a>
</h2>
<p>First we use the 250-m resolution covariates:</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"input/edgeroi.grids.rda"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/sp/man/gridded-methods.html">gridded</a></span><span class="op">(</span><span class="va">edgeroi.grids</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="op">~</span><span class="va">x</span><span class="op">+</span><span class="va">y</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html">proj4string</a></span><span class="op">(</span><span class="va">edgeroi.grids</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/CRS-class.html">CRS</a></span><span class="op">(</span><span class="st">"+init=epsg:28355"</span><span class="op">)</span>
<span class="va">ov2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">edgeroi.sp</span>, <span class="va">edgeroi.grids</span><span class="op">)</span>
<span class="va">ov2</span><span class="op">$</span><span class="va">SOURCEID</span> <span class="op">&lt;-</span> <span class="va">edgeroi.sp</span><span class="op">$</span><span class="va">SOURCEID</span>
<span class="va">ov2</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="va">edgeroi.sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">ov2</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">edgeroi.sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></code></pre></div>
<p>This is a 3D soil data set, so we also use the horizon <code>DEPTH</code> to explain distribution of SOC in soil:</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"PSM_functions.R"</span><span class="op">)</span>
<span class="va">h2</span> <span class="op">&lt;-</span> <span class="fu">hor2xyd</span><span class="op">(</span><span class="va">edgeroi</span><span class="op">$</span><span class="va">horizons</span><span class="op">)</span>
<span class="co">## regression matrix:</span>
<span class="va">rm2</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/join_all.html">join_all</a></span><span class="op">(</span>dfs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">edgeroi</span><span class="op">$</span><span class="va">sites</span>, <span class="va">h2</span>, <span class="va">ov2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Joining by: SOURCEID</span>
<span class="co">#&gt; Joining by: SOURCEID</span>
<span class="va">formulaStringP2</span> <span class="op">&lt;-</span> <span class="va">ORCDRC</span> <span class="op">~</span> <span class="va">DEMSRT5</span><span class="op">+</span><span class="va">TWISRT5</span><span class="op">+</span><span class="va">EV1MOD5</span><span class="op">+</span><span class="va">EV2MOD5</span><span class="op">+</span><span class="va">EV3MOD5</span><span class="op">+</span><span class="va">DEPTH</span>
<span class="va">rmP2</span> <span class="op">&lt;-</span> <span class="va">rm2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">rm2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">formulaStringP2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">rmP2</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">formulaStringP2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    4972 obs. of  7 variables:</span>
<span class="co">#&gt;  $ ORCDRC : num  8.5 7.3 5 4.7 4.7 ...</span>
<span class="co">#&gt;  $ DEMSRT5: num  198 198 198 198 198 198 185 185 185 185 ...</span>
<span class="co">#&gt;  $ TWISRT5: num  19.5 19.5 19.5 19.5 19.5 19.5 19.2 19.2 19.2 19.2 ...</span>
<span class="co">#&gt;  $ EV1MOD5: num  1.14 1.14 1.14 1.14 1.14 1.14 -4.7 -4.7 -4.7 -4.7 ...</span>
<span class="co">#&gt;  $ EV2MOD5: num  1.62 1.62 1.62 1.62 1.62 1.62 3.46 3.46 3.46 3.46 ...</span>
<span class="co">#&gt;  $ EV3MOD5: num  -5.74 -5.74 -5.74 -5.74 -5.74 -5.74 0.01 0.01 0.01 0.01 ...</span>
<span class="co">#&gt;  $ DEPTH  : num  11.5 17.5 26 55 80 ...</span></code></pre></div>
<p>We can now fit an EML directly by using the derived regression matrix:</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"m.oc"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">m.oc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/train.spLearner.matrix.html">train.spLearner.matrix</a></span><span class="op">(</span><span class="va">rmP2</span>, <span class="va">formulaStringP2</span>, <span class="va">edgeroi.grids</span>, 
                        parallel<span class="op">=</span><span class="cn">FALSE</span>, cov.model<span class="op">=</span><span class="st">"nugget"</span>, cell.size<span class="op">=</span><span class="fl">1000</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; as.geodata: 4655 replicated data locations found. </span>
<span class="co">#&gt;  Consider using jitterDupCoords() for jittering replicated locations. </span>
<span class="co">#&gt; WARNING: there are data at coincident or very closed locations, some of the geoR's functions may not work.</span>
<span class="co">#&gt;  Use function dup.coords() to locate duplicated coordinates.</span>
<span class="co">#&gt;  Consider using jitterDupCoords() for jittering replicated locations </span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 253895.808438 </span>
<span class="co">#&gt; iter  10 value 131424.395513</span>
<span class="co">#&gt; iter  20 value 92375.545449</span>
<span class="co">#&gt; iter  30 value 88023.497878</span>
<span class="co">#&gt; iter  40 value 78161.622563</span>
<span class="co">#&gt; iter  50 value 71869.588437</span>
<span class="co">#&gt; iter  60 value 69482.655270</span>
<span class="co">#&gt; iter  70 value 68642.175705</span>
<span class="co">#&gt; iter  80 value 68405.025197</span>
<span class="co">#&gt; iter  90 value 68402.034647</span>
<span class="co">#&gt; final  value 68402.000553 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 254790.970425 </span>
<span class="co">#&gt; final  value 136782.219163 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 285010.126650 </span>
<span class="co">#&gt; final  value 135478.529982 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 253832.562811 </span>
<span class="co">#&gt; final  value 137484.280876 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 254385.881547 </span>
<span class="co">#&gt; iter  10 value 98551.221418</span>
<span class="co">#&gt; iter  20 value 94579.214923</span>
<span class="co">#&gt; iter  30 value 93473.664614</span>
<span class="co">#&gt; iter  40 value 93169.177514</span>
<span class="co">#&gt; iter  50 value 93139.660457</span>
<span class="co">#&gt; iter  60 value 93111.617240</span>
<span class="co">#&gt; iter  70 value 93111.256287</span>
<span class="co">#&gt; iter  80 value 93109.156591</span>
<span class="co">#&gt; iter  90 value 93099.925818</span>
<span class="co">#&gt; iter 100 value 93021.880998</span>
<span class="co">#&gt; final  value 93021.880998 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 233465.782262 </span>
<span class="co">#&gt; final  value 134647.206038 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 246624.689888 </span>
<span class="co">#&gt; final  value 138702.343415 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 241227.341802 </span>
<span class="co">#&gt; final  value 138599.168021 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 245735.599010 </span>
<span class="co">#&gt; final  value 131152.446689 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 258267.657849 </span>
<span class="co">#&gt; iter  10 value 97368.003255</span>
<span class="co">#&gt; iter  20 value 91058.331259</span>
<span class="co">#&gt; iter  30 value 88735.472097</span>
<span class="co">#&gt; iter  40 value 78495.790097</span>
<span class="co">#&gt; iter  50 value 72384.348608</span>
<span class="co">#&gt; iter  60 value 69221.579542</span>
<span class="co">#&gt; iter  70 value 68248.107158</span>
<span class="co">#&gt; iter  80 value 68073.306874</span>
<span class="co">#&gt; iter  80 value 68073.306453</span>
<span class="co">#&gt; iter  90 value 68072.812884</span>
<span class="co">#&gt; iter  90 value 68072.812251</span>
<span class="co">#&gt; final  value 68072.784169 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; # weights:  25</span>
<span class="co">#&gt; initial  value 268786.613045 </span>
<span class="co">#&gt; iter  10 value 128937.282143</span>
<span class="co">#&gt; iter  20 value 105536.706972</span>
<span class="co">#&gt; iter  30 value 100970.717402</span>
<span class="co">#&gt; iter  40 value 89676.958142</span>
<span class="co">#&gt; iter  50 value 80499.715450</span>
<span class="co">#&gt; iter  60 value 76269.748584</span>
<span class="co">#&gt; iter  70 value 74645.989814</span>
<span class="co">#&gt; iter  80 value 74429.111595</span>
<span class="co">#&gt; iter  90 value 74041.488969</span>
<span class="co">#&gt; iter 100 value 73877.377891</span>
<span class="co">#&gt; final  value 73877.377891 </span>
<span class="co">#&gt; stopped after 100 iterations</span></code></pre></div>
<p>The <strong>geoR</strong> package here reports problems as the data set is 3D and hence there are spatial
duplicates. We can ignore this problem and use the pre-defined cell size of 1-km
for spatial blocking, although in theory one can also fit 3D variograms and then
determine blocking parameter using training data.</p>
<p>The results show that the EML model is significant:</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">m.oc</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -17.668  -0.984  -0.066   0.711  64.291 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;               Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)    0.11730    0.18365   0.639  0.52302    </span>
<span class="co">#&gt; regr.ranger    1.12706    0.02474  45.553  &lt; 2e-16 ***</span>
<span class="co">#&gt; regr.xgboost  -0.37833    0.07448  -5.080 3.92e-07 ***</span>
<span class="co">#&gt; regr.nnet     -0.04227    0.02399  -1.762  0.07808 .  </span>
<span class="co">#&gt; regr.ksvm      0.08299    0.02900   2.861  0.00423 ** </span>
<span class="co">#&gt; regr.cvglmnet -0.05140    0.03879  -1.325  0.18525    </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 3.06 on 4966 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.6938, Adjusted R-squared:  0.6935 </span>
<span class="co">#&gt; F-statistic:  2250 on 5 and 4966 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>We can now predict values at e.g. 5-cm depth by adding a dummy spatial layer with all fixed values:</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out.tif</span> <span class="op">=</span> <span class="st">"output/edgeroi/pred_oc_250m.tif"</span>
<span class="va">edgeroi.grids</span><span class="op">$</span><span class="va">DEPTH</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"edgeroi.oc"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">edgeroi.oc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m.oc</span>, <span class="va">edgeroi.grids</span><span class="op">[</span>,<span class="va">m.oc</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Predicting values using 'getStackedBaseLearnerPredictions'...TRUE</span>
<span class="co">#&gt; Deriving model errors using forestError package...TRUE</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.oc</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"response"</span><span class="op">]</span>, <span class="va">out.tif</span>, 
            options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.oc</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"model.error"</span><span class="op">]</span>, <span class="st">"output/edgeroi/pred_oc_250m_pe.tif"</span>, 
            options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>which shows the following:</p>
<div class="figure" style="text-align: center">
<span id="fig:map-oc250m"></span>
<img src="multiscale-models_files/figure-html/map-oc250m-1.png" alt="Predicted SOC content using 250-m covariates." width="100%"><p class="caption">
Figure 7.2: Predicted SOC content using 250-m covariates.
</p>
</div>
<p>The average prediction error in the map is somewhat higher than the average error from the model fitting:</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">edgeroi.oc</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">model.error</span><span class="op">)</span>
<span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span>
<span class="co">#&gt;   2.323   4.710   6.342   6.929   9.257  15.338</span></code></pre></div>
<p>This is because we are predicting the top-soil SOC, which is exponentially higher at the soil surface and hence average model errors for top soil should be slightly larger than the mean error for the whole soil.</p>
</div>
<div id="fine-scale-model" class="section level2" number="7.4">
<h2>
<span class="header-section-number">7.4</span> Fine-scale model<a class="anchor" aria-label="anchor" href="#fine-scale-model"><i class="fas fa-link"></i></a>
</h2>
<p>We can now fit the fine-scale model independently from the coarse-scale model
using the 100-m resolution covariates. In this case the 100-m covariates are
based on Landsat 8 and gamma radiometrics images (see <code><a href="https://rdrr.io/pkg/landmap/man/edgeroi.html">?edgeroi</a></code> for more details):</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edgeroi.grids100</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html">readRDS</a></span><span class="op">(</span><span class="st">"input/edgeroi.grids.100m.rds"</span><span class="op">)</span>
<span class="co">#gridded(edgeroi.grids100) &lt;- ~x+y</span>
<span class="co">#proj4string(edgeroi.grids100) &lt;- CRS("+init=epsg:28355")</span>
<span class="va">ovF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/over.html">over</a></span><span class="op">(</span><span class="va">edgeroi.sp</span>, <span class="va">edgeroi.grids100</span><span class="op">)</span>
<span class="va">ovF</span><span class="op">$</span><span class="va">SOURCEID</span> <span class="op">&lt;-</span> <span class="va">edgeroi.sp</span><span class="op">$</span><span class="va">SOURCEID</span>
<span class="va">ovF</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="va">edgeroi.sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">ovF</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">edgeroi.sp</span><span class="op">@</span><span class="va">coords</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>
<span class="va">rmF</span> <span class="op">&lt;-</span> <span class="fu">plyr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/plyr/man/join_all.html">join_all</a></span><span class="op">(</span>dfs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">edgeroi</span><span class="op">$</span><span class="va">sites</span>, <span class="va">h2</span>, <span class="va">ovF</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Joining by: SOURCEID</span>
<span class="co">#&gt; Joining by: SOURCEID</span>
<span class="va">formulaStringPF</span> <span class="op">&lt;-</span> <span class="va">ORCDRC</span> <span class="op">~</span> <span class="va">MVBSRT6</span><span class="op">+</span><span class="va">TI1LAN6</span><span class="op">+</span><span class="va">TI2LAN6</span><span class="op">+</span><span class="va">PCKGAD6</span><span class="op">+</span><span class="va">RUTGAD6</span><span class="op">+</span><span class="va">PCTGAD6</span><span class="op">+</span><span class="va">DEPTH</span>
<span class="va">rmPF</span> <span class="op">&lt;-</span> <span class="va">rmF</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">rmF</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">formulaStringPF</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">rmPF</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/allnames.html">all.vars</a></span><span class="op">(</span><span class="va">formulaStringPF</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; 'data.frame':    5001 obs. of  8 variables:</span>
<span class="co">#&gt;  $ ORCDRC : num  8.5 7.3 5 4.7 4.7 ...</span>
<span class="co">#&gt;  $ MVBSRT6: num  5.97 5.97 5.97 5.97 5.97 5.97 6.7 6.7 6.7 6.7 ...</span>
<span class="co">#&gt;  $ TI1LAN6: num  31.8 31.8 31.8 31.8 31.8 31.8 14.3 14.3 14.3 14.3 ...</span>
<span class="co">#&gt;  $ TI2LAN6: num  32.9 32.9 32.9 32.9 32.9 32.9 22.1 22.1 22.1 22.1 ...</span>
<span class="co">#&gt;  $ PCKGAD6: num  1.39 1.39 1.39 1.39 1.39 1.39 1.06 1.06 1.06 1.06 ...</span>
<span class="co">#&gt;  $ RUTGAD6: num  0.14 0.14 0.14 0.14 0.14 0.14 0.16 0.16 0.16 0.16 ...</span>
<span class="co">#&gt;  $ PCTGAD6: num  7.82 7.82 7.82 7.82 7.82 7.82 6.48 6.48 6.48 6.48 ...</span>
<span class="co">#&gt;  $ DEPTH  : num  11.5 17.5 26 55 80 ...</span></code></pre></div>
<p>We fit the 2nd fine-scale model:</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"m.ocF"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">m.ocF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/landmap/man/train.spLearner.matrix.html">train.spLearner.matrix</a></span><span class="op">(</span><span class="va">rmPF</span>, <span class="va">formulaStringPF</span>, <span class="va">edgeroi.grids100</span>, 
                        parallel<span class="op">=</span><span class="cn">FALSE</span>, cov.model<span class="op">=</span><span class="st">"nugget"</span>, cell.size<span class="op">=</span><span class="fl">1000</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; as.geodata: 4655 replicated data locations found. </span>
<span class="co">#&gt;  Consider using jitterDupCoords() for jittering replicated locations. </span>
<span class="co">#&gt; WARNING: there are data at coincident or very closed locations, some of the geoR's functions may not work.</span>
<span class="co">#&gt;  Use function dup.coords() to locate duplicated coordinates.</span>
<span class="co">#&gt;  Consider using jitterDupCoords() for jittering replicated locations </span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 259952.010839 </span>
<span class="co">#&gt; iter  10 value 101252.397395</span>
<span class="co">#&gt; iter  20 value 92849.746212</span>
<span class="co">#&gt; iter  30 value 84138.890538</span>
<span class="co">#&gt; iter  40 value 81171.674547</span>
<span class="co">#&gt; iter  50 value 80244.316069</span>
<span class="co">#&gt; iter  60 value 79942.755705</span>
<span class="co">#&gt; iter  70 value 79714.285817</span>
<span class="co">#&gt; iter  80 value 78299.292931</span>
<span class="co">#&gt; iter  90 value 77660.229627</span>
<span class="co">#&gt; iter 100 value 76439.632084</span>
<span class="co">#&gt; final  value 76439.632084 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 226902.901029 </span>
<span class="co">#&gt; iter  10 value 134520.116202</span>
<span class="co">#&gt; iter  20 value 106665.533239</span>
<span class="co">#&gt; iter  30 value 100456.523529</span>
<span class="co">#&gt; iter  40 value 94907.032527</span>
<span class="co">#&gt; iter  50 value 94598.860459</span>
<span class="co">#&gt; iter  60 value 94311.934401</span>
<span class="co">#&gt; iter  70 value 93110.357174</span>
<span class="co">#&gt; iter  80 value 92843.643684</span>
<span class="co">#&gt; iter  90 value 92584.240506</span>
<span class="co">#&gt; iter 100 value 92181.626755</span>
<span class="co">#&gt; final  value 92181.626755 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 234725.323531 </span>
<span class="co">#&gt; iter  10 value 99738.688037</span>
<span class="co">#&gt; iter  20 value 95202.777671</span>
<span class="co">#&gt; iter  30 value 93332.714310</span>
<span class="co">#&gt; iter  40 value 84502.258499</span>
<span class="co">#&gt; iter  50 value 81245.631274</span>
<span class="co">#&gt; iter  60 value 80530.199169</span>
<span class="co">#&gt; iter  70 value 79322.812976</span>
<span class="co">#&gt; iter  80 value 78753.418713</span>
<span class="co">#&gt; iter  90 value 78202.739332</span>
<span class="co">#&gt; iter 100 value 76862.478845</span>
<span class="co">#&gt; final  value 76862.478845 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 264624.170952 </span>
<span class="co">#&gt; iter  10 value 101566.765280</span>
<span class="co">#&gt; iter  20 value 93105.271953</span>
<span class="co">#&gt; iter  30 value 79221.559605</span>
<span class="co">#&gt; iter  40 value 75397.256524</span>
<span class="co">#&gt; iter  50 value 74837.821575</span>
<span class="co">#&gt; iter  60 value 74267.997307</span>
<span class="co">#&gt; iter  70 value 73584.671645</span>
<span class="co">#&gt; iter  80 value 72824.651446</span>
<span class="co">#&gt; iter  90 value 67855.243367</span>
<span class="co">#&gt; iter 100 value 64355.252219</span>
<span class="co">#&gt; final  value 64355.252219 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 269334.603789 </span>
<span class="co">#&gt; iter  10 value 114589.803267</span>
<span class="co">#&gt; iter  20 value 98585.812766</span>
<span class="co">#&gt; iter  30 value 95611.345448</span>
<span class="co">#&gt; iter  40 value 94119.323802</span>
<span class="co">#&gt; iter  50 value 90814.981698</span>
<span class="co">#&gt; iter  60 value 87341.568604</span>
<span class="co">#&gt; iter  70 value 81668.185752</span>
<span class="co">#&gt; iter  80 value 78304.161754</span>
<span class="co">#&gt; iter  90 value 77329.599858</span>
<span class="co">#&gt; iter 100 value 76085.626220</span>
<span class="co">#&gt; final  value 76085.626220 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 259884.878897 </span>
<span class="co">#&gt; iter  10 value 103726.379375</span>
<span class="co">#&gt; iter  20 value 94570.752266</span>
<span class="co">#&gt; iter  30 value 76708.677450</span>
<span class="co">#&gt; iter  40 value 73787.991288</span>
<span class="co">#&gt; iter  50 value 73126.652279</span>
<span class="co">#&gt; iter  60 value 72979.797218</span>
<span class="co">#&gt; iter  70 value 72965.952547</span>
<span class="co">#&gt; iter  80 value 72468.280591</span>
<span class="co">#&gt; iter  90 value 72359.464671</span>
<span class="co">#&gt; iter 100 value 71873.895824</span>
<span class="co">#&gt; final  value 71873.895824 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 285193.065615 </span>
<span class="co">#&gt; iter  10 value 102340.204856</span>
<span class="co">#&gt; iter  20 value 89532.696472</span>
<span class="co">#&gt; iter  30 value 83391.937814</span>
<span class="co">#&gt; iter  40 value 79216.548340</span>
<span class="co">#&gt; iter  50 value 74814.819516</span>
<span class="co">#&gt; iter  60 value 71281.809785</span>
<span class="co">#&gt; iter  70 value 70042.875465</span>
<span class="co">#&gt; iter  80 value 69036.157581</span>
<span class="co">#&gt; iter  90 value 66429.444952</span>
<span class="co">#&gt; iter 100 value 62457.856190</span>
<span class="co">#&gt; final  value 62457.856190 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 209074.598360 </span>
<span class="co">#&gt; iter  10 value 92158.672417</span>
<span class="co">#&gt; iter  20 value 88477.518932</span>
<span class="co">#&gt; iter  30 value 83611.323463</span>
<span class="co">#&gt; iter  40 value 80398.938707</span>
<span class="co">#&gt; iter  50 value 75638.212800</span>
<span class="co">#&gt; iter  60 value 72443.729706</span>
<span class="co">#&gt; iter  70 value 68713.860329</span>
<span class="co">#&gt; iter  80 value 64573.033967</span>
<span class="co">#&gt; iter  90 value 62080.383861</span>
<span class="co">#&gt; iter 100 value 61330.996785</span>
<span class="co">#&gt; final  value 61330.996785 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 264913.914581 </span>
<span class="co">#&gt; iter  10 value 90799.203779</span>
<span class="co">#&gt; iter  20 value 83326.307027</span>
<span class="co">#&gt; iter  30 value 71756.357852</span>
<span class="co">#&gt; iter  40 value 66352.773014</span>
<span class="co">#&gt; iter  50 value 65346.537874</span>
<span class="co">#&gt; iter  60 value 64426.380008</span>
<span class="co">#&gt; iter  70 value 63807.365080</span>
<span class="co">#&gt; iter  80 value 62839.592211</span>
<span class="co">#&gt; iter  90 value 60737.710893</span>
<span class="co">#&gt; iter 100 value 59915.872278</span>
<span class="co">#&gt; final  value 59915.872278 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 254133.236100 </span>
<span class="co">#&gt; iter  10 value 117010.387846</span>
<span class="co">#&gt; iter  20 value 96496.685965</span>
<span class="co">#&gt; iter  30 value 81754.875719</span>
<span class="co">#&gt; iter  40 value 80702.591180</span>
<span class="co">#&gt; iter  50 value 79637.660106</span>
<span class="co">#&gt; iter  60 value 77195.047203</span>
<span class="co">#&gt; iter  70 value 74660.187056</span>
<span class="co">#&gt; iter  80 value 70931.471910</span>
<span class="co">#&gt; iter  90 value 69014.578843</span>
<span class="co">#&gt; iter 100 value 68409.500899</span>
<span class="co">#&gt; final  value 68409.500899 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="co">#&gt; # weights:  28</span>
<span class="co">#&gt; initial  value 325116.468080 </span>
<span class="co">#&gt; iter  10 value 120203.210463</span>
<span class="co">#&gt; iter  20 value 115964.153279</span>
<span class="co">#&gt; iter  30 value 90105.298970</span>
<span class="co">#&gt; iter  40 value 79437.548718</span>
<span class="co">#&gt; iter  50 value 70168.831437</span>
<span class="co">#&gt; iter  60 value 69050.767980</span>
<span class="co">#&gt; iter  70 value 68627.297281</span>
<span class="co">#&gt; iter  80 value 68156.983605</span>
<span class="co">#&gt; iter  90 value 67374.570008</span>
<span class="co">#&gt; iter 100 value 67164.637732</span>
<span class="co">#&gt; final  value 67164.637732 </span>
<span class="co">#&gt; stopped after 100 iterations</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">m.ocF</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">learner.model</span><span class="op">$</span><span class="va">super.model</span><span class="op">$</span><span class="va">learner.model</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; stats::lm(formula = f, data = d)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -19.274  -0.960  -0.052   0.725  61.100 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;                Estimate Std. Error t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; (Intercept)   -0.466388   0.114924  -4.058 5.02e-05 ***</span>
<span class="co">#&gt; regr.ranger    1.098643   0.024682  44.512  &lt; 2e-16 ***</span>
<span class="co">#&gt; regr.xgboost   0.009181   0.075823   0.121   0.9036    </span>
<span class="co">#&gt; regr.nnet      0.048347   0.021791   2.219   0.0266 *  </span>
<span class="co">#&gt; regr.ksvm     -0.029587   0.029579  -1.000   0.3172    </span>
<span class="co">#&gt; regr.cvglmnet -0.038096   0.028892  -1.319   0.1874    </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 2.967 on 4995 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared:  0.7147, Adjusted R-squared:  0.7145 </span>
<span class="co">#&gt; F-statistic:  2503 on 5 and 4995 DF,  p-value: &lt; 2.2e-16</span></code></pre></div>
<p>which shows that the 100-m resolution covariates help make even more accurate
predictions with R-square about 0.7. We can also make predictions at 5-cm depth
by using (note: this takes almost 6x more time to compute predictions than for
250-m resolution data):</p>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edgeroi.grids100</span><span class="op">$</span><span class="va">DEPTH</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">sel.grid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">edgeroi.grids100</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="va">m.ocF</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">]</span><span class="op">)</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"edgeroi.ocF"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">edgeroi.ocF</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html">predict</a></span><span class="op">(</span><span class="va">m.ocF</span>, <span class="va">edgeroi.grids100</span><span class="op">[</span><span class="va">sel.grid</span>, <span class="va">m.ocF</span><span class="op">@</span><span class="va">spModel</span><span class="op">$</span><span class="va">features</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#&gt; Predicting values using 'getStackedBaseLearnerPredictions'...TRUE</span>
<span class="co">#&gt; Deriving model errors using forestError package...TRUE</span>
<span class="va">out.tif</span> <span class="op">=</span> <span class="st">"output/edgeroi/pred_oc_100m.tif"</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"response"</span><span class="op">]</span>, <span class="va">out.tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"model.error"</span><span class="op">]</span>, <span class="st">"output/edgeroi/pred_oc_100m_pe.tif"</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>which shows the following:</p>
<div class="figure" style="text-align: center">
<span id="fig:map-oc100m"></span>
<img src="multiscale-models_files/figure-html/map-oc100m-1.png" alt="Predicted SOC content using 100-m covariates." width="100%"><p class="caption">
Figure 7.3: Predicted SOC content using 100-m covariates.
</p>
</div>
</div>
<div id="merging-multi-scale-predictions" class="section level2" number="7.5">
<h2>
<span class="header-section-number">7.5</span> Merging multi-scale predictions<a class="anchor" aria-label="anchor" href="#merging-multi-scale-predictions"><i class="fas fa-link"></i></a>
</h2>
<p>If we compare the coarse scale and fine scale predictions we see:</p>
<div class="figure" style="text-align: center">
<span id="fig:two-scale"></span>
<img src="img/ebergotzen_two_scale_model_ensemble.gif" alt="Coarse-scale and fine-scale predictions of soil organic carbon at 5-cm depth for the Edgeroi study area." width="100%"><p class="caption">
Figure 7.4: Coarse-scale and fine-scale predictions of soil organic carbon at 5-cm depth for the Edgeroi study area.
</p>
</div>
<p>Overall there is a match between general patterns but there are also differences locally. This is to expect as the two models are fitted independently using completely different covariates. We can merge the two predictions and produce the final ensemble prediction by using the following principles:</p>
<ul>
<li>User prediction errors per pixel as weights so that more accurate predictions get higher weights,<br>
</li>
<li>Derive propagated error using the pooled variance based on individual predictions and errors,</li>
</ul>
<p>Before we run this operation, we need to downscale the maps to the same grid, best using Cubic-splines in GDAL:</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">edgeroi.grids100</span><span class="op">@</span><span class="va">bbox</span>
<span class="co">#&gt;       min     max</span>
<span class="co">#&gt; x  741400  789000</span>
<span class="co">#&gt; y 6646000 6678100</span>
<span class="va">outD.file</span> <span class="op">=</span> <span class="st">"output/edgeroi/pred_oc_250m_100m.tif"</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">outD.file</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'gdalwarp output/edgeroi/pred_oc_250m.tif '</span>, <span class="va">outD.file</span>,  
         <span class="st">' -r \"cubicspline\" -te 741400 6646000 789000 6678100 -tr 100 100 -overwrite'</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/system.html">system</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'gdalwarp output/edgeroi/pred_oc_250m_pe.tif output/edgeroi/pred_oc_250m_100m_pe.tif'</span>,
         <span class="st">' -r \"cubicspline\" -te 741400 6646000 789000 6678100 -tr 100 100 -overwrite'</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We can now read the downscaled predictions, and merge them using the prediction errors as weights (weighted average per pixel):</p>
<div class="sourceCode" id="cb179"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sel.pix</span> <span class="op">=</span> <span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">@</span><span class="va">grid.index</span>
<span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">responseC</span> <span class="op">=</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"output/edgeroi/pred_oc_250m_100m.tif"</span><span class="op">)</span><span class="op">$</span><span class="va">band1</span><span class="op">[</span><span class="va">sel.pix</span><span class="op">]</span>
<span class="co">#&gt; output/edgeroi/pred_oc_250m_100m.tif has GDAL driver GTiff </span>
<span class="co">#&gt; and has 321 rows and 476 columns</span>
<span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">model.errorC</span> <span class="op">=</span> <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">readGDAL</a></span><span class="op">(</span><span class="st">"output/edgeroi/pred_oc_250m_100m_pe.tif"</span><span class="op">)</span><span class="op">$</span><span class="va">band1</span><span class="op">[</span><span class="va">sel.pix</span><span class="op">]</span>
<span class="co">#&gt; output/edgeroi/pred_oc_250m_100m_pe.tif has GDAL driver GTiff </span>
<span class="co">#&gt; and has 321 rows and 476 columns</span>
<span class="va">X</span> <span class="op">=</span> <span class="fu">comp.var</span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">@</span><span class="va">data</span>, r1<span class="op">=</span><span class="st">"response"</span>, r2<span class="op">=</span><span class="st">"responseC"</span>, v1<span class="op">=</span><span class="st">"model.error"</span>, v2<span class="op">=</span><span class="st">"model.errorC"</span><span class="op">)</span>
<span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">responseF</span> <span class="op">=</span> <span class="va">X</span><span class="op">$</span><span class="va">response</span>
<span class="va">out.tif</span> <span class="op">=</span> <span class="st">"output/edgeroi/pred_oc_100m_merged.tif"</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"responseF"</span><span class="op">]</span>, <span class="va">out.tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>The final map of predictions is a combination of the two independently produced predictions <span class="citation">(<a href="references.html#ref-hengl2021african" role="doc-biblioref">Tomislav Hengl et al., 2021</a>)</span>:</p>
<div class="sourceCode" id="cb180"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"responseF"</span><span class="op">]</span><span class="op">)</span>, col<span class="op">=</span><span class="va">R_pal</span><span class="op">[[</span><span class="st">"rainbow_75"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">4</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span>,
  main<span class="op">=</span><span class="st">"Merged predictions spLearner"</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, box<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/lines.html">points</a></span><span class="op">(</span><span class="va">edgeroi.sp</span>, pch<span class="op">=</span><span class="st">"+"</span>, cex<span class="op">=</span><span class="fl">.8</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<span id="fig:map-2scale"></span>
<img src="multiscale-models_files/figure-html/map-2scale-1.png" alt="Merged predictions (coarse+fine scale) of SOC content at 100-m." width="100%"><p class="caption">
Figure 7.5: Merged predictions (coarse+fine scale) of SOC content at 100-m.
</p>
</div>
<p>To merge the prediction errors, we use the pooled variance formula <span class="citation">(<a href="references.html#ref-rudmin2010calculating" role="doc-biblioref">Rudmin, 2010</a>)</span>:</p>
<div class="sourceCode" id="cb181"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">comp.var</span>
<span class="co">#&gt; function (x, r1, r2, v1, v2) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     r = rowSums(x[, c(r1, r2)] * 1/(x[, c(v1, v2)]^2))/rowSums(1/(x[, </span>
<span class="co">#&gt;         c(v1, v2)]^2))</span>
<span class="co">#&gt;     v = sqrt(rowMeans(x[, c(r1, r2)]^2 + x[, c(v1, v2)]^2) - </span>
<span class="co">#&gt;         rowMeans(x[, c(r1, r2)])^2)</span>
<span class="co">#&gt;     return(data.frame(response = r, stdev = v))</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7019e838&gt;</span>
<span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">$</span><span class="va">model.errorF</span> <span class="op">=</span> <span class="va">X</span><span class="op">$</span><span class="va">stdev</span>
<span class="va">out.tif</span> <span class="op">=</span> <span class="st">"output/edgeroi/pred_oc_100m_merged_pe.tif"</span>
<span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">out.tif</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="http://rgdal.r-forge.r-project.org/reference/readGDAL.html">writeGDAL</a></span><span class="op">(</span><span class="va">edgeroi.ocF</span><span class="op">$</span><span class="va">pred</span><span class="op">[</span><span class="st">"model.errorF"</span><span class="op">]</span>, <span class="va">out.tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"COMPRESS=DEFLATE"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>So in summary, merging multi-scale predictions is a straight forward process,
but it assumes that the reliable prediction errors are available for both coarse and fine scale predictions.
The pooled variance might show higher errors where predictions between independent
models differ significantly and this is correct. The 2-scale Ensemble Machine
Learning method of Predictive Soil Mapping was used, for example, to produce
predictions of <a href="https://www.isda-africa.com/isdasoil/">soil properties and nutrients of Africa at 30-m spatial resolution</a> <span class="citation">(<a href="references.html#ref-hengl2021african" role="doc-biblioref">Tomislav Hengl et al., 2021</a>)</span>.</p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="spatiotemporal-prediction-of-soil-organic-carbon.html"><span class="header-section-number">6</span> Spatiotemporal prediction of Soil Organic Carbon</a></div>
<div class="next"><a href="summary-1.html"><span class="header-section-number">8</span> Summary</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#multi-scale-spatial-prediction-models"><span class="header-section-number">7</span> Multi-scale spatial prediction models</a></li>
<li><a class="nav-link" href="#rationale-for-multiscale-models"><span class="header-section-number">7.1</span> Rationale for multiscale models</a></li>
<li><a class="nav-link" href="#fitting-and-predicting-with-multiscale-models"><span class="header-section-number">7.2</span> Fitting and predicting with multiscale models</a></li>
<li><a class="nav-link" href="#coarse-scale-model"><span class="header-section-number">7.3</span> Coarse-scale model</a></li>
<li><a class="nav-link" href="#fine-scale-model"><span class="header-section-number">7.4</span> Fine-scale model</a></li>
<li><a class="nav-link" href="#merging-multi-scale-predictions"><span class="header-section-number">7.5</span> Merging multi-scale predictions</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/OpenGeoHub/spatial-prediction-eml/blob/master/multiscale-models.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/OpenGeoHub/spatial-prediction-eml/edit/master/multiscale-models.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Spatial and spatiotemporal interpolation using Ensemble Machine Learning</strong>" was written by Tom Hengl, Leandro Parente, Carmelo Bonannella and contributors. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
